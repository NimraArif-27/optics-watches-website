<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Khalid Optics & Watches</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      display: flex;
      min-height: 100vh;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: #f8f9fa;
    }
    #sidebar {
      width: 250px;
      background-color: #343a40;
      color: #fff;
      flex-shrink: 0;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;       /* Full screen height */
      overflow-y: auto;    /* Scroll only inside sidebar if content is long */
    }
    #sidebar .nav-link {
      color: #ddd;
    }
    #sidebar .nav-link.active, #sidebar .nav-link:hover {
      background-color: #007bff;
      color: #fff;
    }
    #content { flex-grow: 1; display: flex; flex-direction: column; margin-left: 250px;}
    .content-section { display: none; }
    .content-section.active { display: block; }
    .card { border-radius: .75rem; }
    .footer { background:#343a40;color:#ddd;padding:10px;text-align:center; }
    /* Style for chart containers */
    .chart-container {
      position: relative;
      height: 300px; /* Adjust height as needed */
      width: 100%;
    }

    /* --- New Summary Card Styles --- */
    .summary-card {
      border-radius: 1rem; /* More rounded corners */
      color: #fff; /* White text for better contrast on gradients */
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); /* Stronger shadow */
      overflow: hidden; /* Ensures gradient stays within bounds */
      position: relative;
      padding: 20px; /* Increased padding */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%; /* Ensure cards take full height in row */
    }

    .summary-card.bg-primary {
      background: linear-gradient(45deg, #007bff, #0056b3); /* Blue gradient */
    }
    .summary-card.bg-success {
      background: linear-gradient(45deg, #28a745, #1e7e34); /* Green gradient */
    }
    .summary-card.bg-warning {
      background: linear-gradient(45deg, #ffc107, #e0a800); /* Yellow/Orange gradient */
    }

    .summary-card .card-title {
      font-size: 1.1rem; /* Slightly smaller title */
      margin-bottom: 0.5rem;
      opacity: 0.8; /* Make title slightly transparent */
    }

    .summary-card .card-text {
      font-size: 2.8rem; /* Larger number */
      font-weight: bold;
      line-height: 1; /* Tighter line height */
    }

    .summary-card .icon-background {
      position: absolute;
      bottom: -10px;
      right: -10px;
      font-size: 5rem; /* Large icon */
      color: rgba(255, 255, 255, 0.15); /* Semi-transparent white */
      z-index: 0;
    }

    .summary-card .card-body {
      position: relative; /* To keep content above icon */
      z-index: 1;
      padding: 0; /* Remove default card-body padding */
    }

    /* New styles for product cards in grid */
    .product-card {
      border: 1px solid #e0e0e0;
      border-radius: 0.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      text-align: center; /* Center image and text */
    }

    .product-card .card-img-top {
      max-width: 100%;
      height: 180px; /* Increased height for better visibility */
      object-fit: cover; /* Changed to cover to fill the space */
      /* Removed padding to allow image to fill more space */
      border-bottom: 1px solid #eee; /* Keep border for separation */
    }

    .product-card .card-body {
      padding: 15px;
    }

    .product-card .card-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: #333;
    }

    .product-card .card-text {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 5px;
    }

    .product-card .card-footer {
      background-color: #f8f9fa;
      border-top: 1px solid #e9ecef;
      padding: 10px 15px;
    }

    .comment-cell {
      max-width: 200px;       /* restrict width */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      vertical-align: top;
    }

    .comment-cell.expanded {
      white-space: normal;   /* allow wrapping */
      overflow: visible;
      text-overflow: clip;
    }
    .message-cell {
      max-width: 200px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .message-cell.expanded {
      white-space: normal;    /* allow wrapping */
      overflow: visible;
      text-overflow: unset;
      max-height: 150px;      /* fixed block height */
      overflow-y: auto;       /* scrollbar if too long */
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<nav id="sidebar" class="d-flex flex-column p-3">
  <h4 class="text-center">Khalid Optics</h4>
  <ul class="nav flex-column mt-3">
    <li class="nav-item"><a class="nav-link active" href="#" data-section="dashboard-overview"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
    
    <!-- Products Section with Submenu -->
    <li class="nav-item">
      <a class="nav-link" href="#productsSubmenu" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="productsSubmenu">
        <i class="fas fa-box"></i> Products <i class="fas fa-chevron-down float-end"></i>
      </a>
      <div class="collapse" id="productsSubmenu">
        <ul class="nav flex-column ms-3">
          <li class="nav-item"><a class="nav-link" href="#" data-section="eyeglasses-products">Eyeglasses</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-section="sunglasses-products">Sunglasses</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-section="watches-products">Watches</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-section="lenses-products">Lenses</a></li>
        </ul>
      </div>
    </li>

    <li class="nav-item"><a class="nav-link" href="#" data-section="orders-management"><i class="fas fa-shopping-cart"></i> Orders</a></li>
    <li class="nav-item"><a class="nav-link" href="#" data-section="reviews-management"><i class="fas fa-star"></i> Reviews</a></li>
    <li class="nav-item"><a class="nav-link" href="#" data-section="contact-us-management"><i class="fas fa-address-book"></i> Contact Us</a></li>
    <li class="nav-item"><a class="nav-link" href="#" data-section="site-settings"><i class="fas fa-cog"></i> Site Settings</a></li>
  </ul>
</nav>

<!-- Content -->
<div id="content">
  <nav class="navbar bg-light border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand">Admin Dashboard</a>
    </div>
  </nav>

  <main class="flex-grow-1 p-4">

    <!-- Dashboard Overview -->
    <section id="dashboard-overview" class="content-section active">
      <h2>Dashboard Overview</h2>
      <!-- Summary Cards -->
      <div class="row">
        <div class="col-md-4 mb-4">
          <div class="summary-card bg-primary">
            <div class="card-body">
              <h5 class="card-title">Total Orders</h5>
              <p class="card-text" id="totalOrders">0</p>
            </div>
            <div class="icon-background"><i class="fas fa-shopping-cart"></i></div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="summary-card bg-warning">
            <div class="card-body">
              <h5 class="card-title">Pending Orders</h5>
              <p class="card-text" id="pendingOrdersCount">0</p>
            </div>
            <div class="icon-background"><i class="fas fa-envelope"></i></div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="summary-card bg-success">
            <div class="card-body">
              <h5 class="card-title">Customer Reviews</h5>
              <p class="card-text" id="customerReviewsCount">0</p>
            </div>
            <div class="icon-background"><i class="fas fa-user-plus"></i></div>
          </div>
        </div>
      </div>

      <h3 class="mt-4">Sales & Customer Trends</h3>
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Monthly Orders</span>
              <select id="yearSelect" class="form-select form-select-sm w-auto">
                <!-- Options will be populated dynamically -->
              </select>

            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="monthlyOrdersChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Sales by Category</span>
              <select id="monthSelect" class="form-select form-select-sm w-auto">
                <!-- Options will be populated dynamically -->
              </select>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="salesByCategoryChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========================= EYEGLASSES PAGE ======================= -->
    <!-- Products Management - Eyeglasses -->
    <section id="eyeglasses-products" class="content-section">
      <h2>Eyeglasses Products</h2>
      <ul class="nav nav-tabs mb-3" id="eyeglassesTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#metalFrames">Metal Frames</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#regularGlasses">Regular Glasses</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#brandedFrames">Branded Frames</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#kidsEyeglasses">Kids Section</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="metalFrames">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Metal Frames Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://i.ebayimg.com/images/g/zCAAAOSwC-5d6Duf/s-l1200.jpg" class="card-img-top" alt="Classic Aviator Metal Frame">
                    <div class="card-body">
                      <h5 class="card-title">Classic Aviator Metal Frame</h5>
                      <p class="card-text"><strong>ID:</strong> EG001</p>
                      <p class="card-text"><strong>Price:</strong> $120.00</p>
                      <p class="card-text"><strong>Stock:</strong> 50</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="regularGlasses">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Regular Glasses Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://www.shutterstock.com/image-photo/pair-blue-prescription-eye-glasses-260nw-2472127101.jpg" class="card-img-top" alt="Everyday Clear Frame">
                    <div class="card-body">
                      <h5 class="card-title">Everyday Clear Frame</h5>
                      <p class="card-text"><strong>ID:</strong> RG001</p>
                      <p class="card-text"><strong>Price:</strong> $75.00</p>
                      <p class="card-text"><strong>Stock:</strong> 100</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="brandedFrames">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Branded Frames Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS7Ts3rohc1q_Dzu03nIK2rRa2G5FiIJziBuDMoXHBYKmSUp9fJPFg_1nieJ4yXQzQAnyQ&usqp=CAU" class="card-img-top" alt="Ray-Ban Wayfarer">
                    <div class="card-body">
                      <h5 class="card-title">Ray-Ban Wayfarer</h5>
                      <p class="card-text"><strong>ID:</strong> BF001</p>
                      <p class="card-text"><strong>Brand:</strong> Ray-Ban</p>
                      <p class="card-text"><strong>Price:</strong> $180.00</p>
                      <p class="card-text"><strong>Stock:</strong> 25</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="kidsEyeglasses">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Kids Eyeglasses Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSzwFrPfDh1LJCrmJUVuCYeixuNDl9cBo9mS-lFL5sNTBbRu5838xiks-9nur8Ts7ArT5Q&usqp=CAU" class="card-img-top" alt="Colorful Round Frame">
                    <div class="card-body">
                      <h5 class="card-title">Colorful Round Frame</h5>
                      <p class="card-text"><strong>ID:</strong> KEG001</p>
                      <p class="card-text"><strong>Age Group:</strong> 3-8</p>
                      <p class="card-text"><strong>Price:</strong> $50.00</p>
                      <p class="card-text"><strong>Stock:</strong> 40</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Add Eyeglasses Product Modal -->
    <div class="modal fade" id="addEyeglassesModal" tabindex="-1">
      <div class="modal-dialog modal-lg">   
        <form id="addEyeglassesForm" class="needs-validation" enctype="multipart/form-data" novalidate autocomplete="off">
          <div class="modal-content">
            <div class="modal-header text-white bg-primary">
              <h5 class="modal-title">Add Eyeglasses Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
 
            <div class="modal-body">
              <input type="hidden" name="category" id="eyeglassesCategory">

              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" name="name" class="form-control" required>
                <div class="invalid-feedback">Product name is required.</div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
              </div>

              <!-- Price -->
              <div class="mb-3">
                <label class="form-label">Price</label>
                <input type="number" name="price" class="form-control" min="1" step="any" required>
                <div class="invalid-feedback">Price is required and must be greater than zero.</div>
              </div>

              <!-- Stock -->
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input type="number" name="stock" class="form-control" min="1" step="1" required>
                <div class="invalid-feedback">Stock is required and must be greater than zero.</div>
              </div>

              <!-- Age Group (Kids only) -->
              <div class="mb-3 d-none" id="ageGroupWrapper">
                <label class="form-label">Age Group</label>
                  <select name="ageGroup" class="form-control" required>
                    <option value="3-5 years">3–5 Years</option>
                    <option value="6-8 years">6–8 Years</option>
                    <option value="9-12 years">9–12 Years</option>
                    <option value="13-15 years">13–15 Years</option>
                  </select>
              </div>

              <!-- Main Image -->
              <div class="mb-3">
                <label class="form-label">Main Image</label>
                <input type="file" name="mainImage" class="form-control" accept="image/*" required>
                <div class="invalid-feedback">Main product image is required.</div>
              </div>

              <!-- Sub Images -->
              <div class="mb-3">
                <label class="form-label">Sub Images (up to 3)</label>
                <input type="file" name="subImages" class="form-control" accept="image/*" multiple>
              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save Product</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- Eyeglasses Confirmation Modal -->
    <div class="modal fade" id="eyeglassesConfirmationModal" tabindex="-1">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content rounded-2" style="width: 350px; height: 200px; margin: auto;">
          <div class="modal-body d-flex flex-column justify-content-center align-items-center text-center">
            <p id="eyeglassesConfirmationMessage" class="fs-4"></p>
          </div>
        </div>
      </div>
    </div>
    <!-- View Eyeglass Modal -->
    <div class="modal fade" id="viewEyeglassModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Product Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewEyeglassModalBody">
          <!-- Product details will be dynamically injected here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Eyeglass Product Modal -->
    <div class="modal fade" id="editEyeglassProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info">
            <h5 class="modal-title">Edit Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editEyeglassForm" autocomplete="off" novalidate>
              <input type="hidden" id="editProductId" name="productId">

              <div class="mb-3">
                <label for="editName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="editName" name="name" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="editPrice" name="price" min="1" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editStock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="editStock" name="stock" min="1" autocomplete="off"  required>
              </div>

              <div class="mb-3 d-none" id="editAgeGroupWrapper">
                <label for="editAgeGroup" class="form-label">Age Group</label>
                <select class="form-select" id="editAgeGroup" name="ageGroup">
                  <option value="3-5 years">3-5 Years</option>
                  <option value="6-8 years">6-8 Years</option>
                  <option value="9-12 years">9-12 Years</option>
                  <option value="13-15 years">13-15 Years</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" form="editEyeglassForm" class="btn btn-info">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Delete Eyeglass Modal -->
    <div class="modal fade" id="deleteEyeglassProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this Product?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteEyeglassBtn" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Eyeglasses Product JS -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const addButtons = document.querySelectorAll(
          "#eyeglasses-products .btn-primary"
        );

        const categoryInput = document.getElementById("eyeglassesCategory");
        const addProductForm = document.getElementById("addEyeglassesForm");
        const ageGroupWrapper = document.getElementById("ageGroupWrapper");
        const addProductModalEl = document.getElementById("addEyeglassesModal");

        // Map which button belongs to which category
        const categories = {
          metalFrames: "metalFrames",
          regularGlasses: "regularGlasses",
          brandedFrames: "brandedFrames",
          kidsEyeglasses: "kidsEyeglasses",
        };

        addButtons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            // Reset form *before opening modal*
            addProductForm.reset();

            const tabId = e.target.closest(".tab-pane").getAttribute("id");
            const category = categories[tabId];

            categoryInput.value = category;

            // Show/hide Age Group for Kids section
            if (category === "kidsEyeglasses") {
              ageGroupWrapper.classList.remove("d-none");
            } else {
              ageGroupWrapper.classList.add("d-none");
            }

            new bootstrap.Modal(document.getElementById("addEyeglassesModal")).show();
          });
        });

        // Reset form when modal is CLOSED (cancel, click outside, etc.)
        addProductModalEl.addEventListener("hidden.bs.modal", () => {
          addProductForm.reset();
          categoryInput.value = "";
          ageGroupWrapper.classList.add("d-none");
        });

        // Form submit
        addProductForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Form Validation
          let valid = true;

          // Clear old errors
          addProductForm.querySelectorAll(".error-message").forEach(el => el.remove());

          const name = addProductForm.querySelector("[name='name']");
          const price = addProductForm.querySelector("[name='price']");
          const stock = addProductForm.querySelector("[name='stock']");
          const mainImage = addProductForm.querySelector("[name='mainImage']");

          // product name
          if (!name.value.trim()) {
            showError(name, "Product name is required");
            valid = false;
          }

          // price
          if (!price.value || price.value <= 0) {
            showError(price, "Price is required and must be greater than zero.");
            valid = false;
          }

          // stock
          if (!stock.value || stock.value <= 0) {
            showError(stock, "Stock is required and must be greater than zero.");
            valid = false;
          }

          // main image
          if (!mainImage.files || mainImage.files.length === 0) {
            showError(mainImage, "Main image is required");
            valid = false;
          }

          if (!valid) return; // stop here if validation fails


          const formData = new FormData(addProductForm);

          const res = await fetch("/api/eyeglasses/add", {
            method: "POST",
            body: formData,
          });

          const data = await res.json();

          // Close add product modal if open
          const addModal = bootstrap.Modal.getInstance(document.getElementById("addEyeglassesModal"));
          if (addModal) addModal.hide();

          // Show confirmation modal
          const confirmationMessage = document.getElementById("eyeglassesConfirmationMessage");
          const confirmationModalEl = document.getElementById("eyeglassesConfirmationModal");
          const confirmationModal = new bootstrap.Modal(confirmationModalEl);

          if (data.success) {
            confirmationMessage.innerHTML = `<i class="fas fa-check-circle text-primary"></i> Product added successfully!`;
            confirmationModal.show();

            // Auto reload after short delay
            setTimeout(() => location.reload(), 3000);
          } else {
            confirmationMessage.innerText = "❌ Error adding product.";
            confirmationModal.show();
          }
        });

        // helper function to show errors
        function showError(input, message) {
          // avoid duplicate error
          if (input.parentNode.querySelector(".error-message")) return;

          const error = document.createElement("div");
          error.className = "error-message text-danger small mt-1";
          error.innerText = message;
          input.parentNode.appendChild(error);

          // Remove error when user focuses OR types
          function clearError() {
            const existingError = input.parentNode.querySelector(".error-message");
            if (existingError) existingError.remove();
            input.removeEventListener("focus", clearError);
            input.removeEventListener("input", clearError);
          }

          input.addEventListener("focus", clearError);
          input.addEventListener("input", clearError);
        }
      });

      //get the product in dashboard
      document.addEventListener("DOMContentLoaded", () => {
        const categories = ["metalFrames", "regularGlasses", "brandedFrames", "kidsEyeglasses"];

        categories.forEach(category => {
          fetch(`/api/eyeglasses/${category}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const container = document.querySelector(`#${category} .row`);
                container.innerHTML = ""; // clear demo product

                data.products.forEach(product => {
                  const card = document.createElement("div");
                  card.className = "col-md-3 mb-4";
                  card.innerHTML = `
                    <div class="card product-card h-100">
                      <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                      <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        ${
                          product.category === "kidsEyeglasses" 
                            ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>` 
                            : ""
                        }
                        <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                        <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                      </div>
                      <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                          <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  `;
                  container.appendChild(card);
                });
              }
            });
        });

        // Handle View button click using event delegation
        document.addEventListener("click", (e) => {
          const btn = e.target.closest(".view-product-btn");
          if (!btn) return;

          const productId = btn.dataset.id;

          // Fetch product details by ID
          fetch(`/api/eyeglasses/product/${productId}`)
            .then(res => res.json())
            .then(product => {
              if (!product || !product.success) return;

              const p = product.product; // assume API returns { success: true, product: {...} }

              const modalBody = document.getElementById("viewEyeglassModalBody");
              modalBody.innerHTML = `
                <div class="row">
                  <div class="col-md-5 text-center">
                    <img src="${p.mainImage}" class="img-fluid rounded mb-3" alt="${p.name}">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                      ${
                        p.subImages && p.subImages.length
                          ? p.subImages.map(img => `<img src="${img}" class="img-thumbnail" style="width:80px; height:80px;">`).join("")
                          : ""
                      }
                    </div>
                  </div>
                  <div class="col-md-7">
                    <h4>${p.name}</h4>
                    <p>${p.description || "No description available."}</p>
                    <p><strong>Price:</strong> Rs. ${p.price}</p>
                    <p><strong>Stock:</strong> ${p.stock}</p>
                    ${
                      p.category === "kidsEyeglasses"
                        ? `<p><strong>Age Group:</strong> ${p.ageGroup}</p>`
                        : ""
                    }
                  </div>
                </div>
              `;

              new bootstrap.Modal(document.getElementById("viewEyeglassModal")).show();
            });
        });

        // EDIT PRODUCT
        const editModalEl = document.getElementById("editEyeglassProductModal");
        const editModal = new bootstrap.Modal(editModalEl);
        const editForm = document.getElementById("editEyeglassForm");
        const editProductId = document.getElementById("editProductId");
        const editName = document.getElementById("editName");
        const editPrice = document.getElementById("editPrice");
        const editStock = document.getElementById("editStock");
        const editAgeGroupWrapper = document.getElementById("editAgeGroupWrapper");
        const editAgeGroup = document.getElementById("editAgeGroup");

        // Helper functions for error messages
        function showError(inputEl, message) {
          let errorEl = inputEl.parentElement.querySelector(".error-text");
          if (!errorEl) {
            errorEl = document.createElement("div");
            errorEl.className = "error-text text-danger mt-1";
            inputEl.parentElement.appendChild(errorEl);
          }
          errorEl.textContent = message;
        }

        function clearError(inputEl) {
          const errorEl = inputEl.parentElement.querySelector(".error-text");
          if (errorEl) errorEl.textContent = "";
        }

        // Clear form + errors
        function resetEditForm() {
          editForm.reset();
          [editName, editPrice, editStock, editAgeGroup].forEach(clearError);
          editProductId.value = "";
          editAgeGroupWrapper.classList.add("d-none");
        }

        // Remove error when user focuses or types
        [editName, editPrice, editStock, editAgeGroup].forEach(input => {
          input.addEventListener("focus", () => clearError(input));
          input.addEventListener("input", () => clearError(input));
        });

        // Reset form whenever modal closes (Cancel or after Save)
        editModalEl.addEventListener("hidden.bs.modal", resetEditForm);

        // Open modal and load product data
        document.addEventListener("click", async (e) => {
          const btn = e.target.closest(".edit-product-btn"); // edit button
          if (!btn) return;

          const productId = btn.dataset.id;

          try {
            const res = await fetch(`/api/eyeglasses/product/${productId}`);
            const data = await res.json();

            if (data.success) {
              const p = data.product;

              editProductId.value = p._id;
              editName.value = p.name;
              editPrice.value = p.price;
              editStock.value = p.stock;

              if (p.category === "kidsEyeglasses") {
                editAgeGroupWrapper.classList.remove("d-none");
                editAgeGroup.value = p.ageGroup || "";
              } else {
                editAgeGroupWrapper.classList.add("d-none");
                editAgeGroup.value = "";
              }

              editModal.show();
            }
          } catch (err) {
            console.error("Error fetching product for edit:", err);
          }
        });

        // Handle save changes
        editForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          let isValid = true;

          // Validate Name
          if (!editName.value.trim()) {
            showError(editName, "Name is required");
            isValid = false;
          } else {
            clearError(editName);
          }

          // Validate Price
          if (editPrice.value === "" || isNaN(editPrice.value) || Number(editPrice.value) < 0) {
            showError(editPrice, "Price must be a valid non-negative number");
            isValid = false;
          } else {
            clearError(editPrice);
          }

          // Validate Stock
          if (editStock.value === "" || isNaN(editStock.value) || Number(editStock.value) < 0) {
            showError(editStock, "Stock must be a valid non-negative number");
            isValid = false;
          } else {
            clearError(editStock);
          }

          if (!isValid) return; // stop if validation fails

          const updatedProduct = {
            name: editName.value.trim(),
            price: Number(editPrice.value),
            stock: Number(editStock.value),
          };

          // only send ageGroup if the field is visible
          if (!editAgeGroupWrapper.classList.contains("d-none")) {
            updatedProduct.ageGroup = editAgeGroup.value;
          }

          try {
            const res = await fetch(`/api/eyeglasses/update/${editProductId.value}`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedProduct),
            });

            const data = await res.json();

            if (data.success) {
              editModal.hide(); // modal close will trigger resetEditForm()

              // Refresh only products inside categories
              const updatedCategory = data.product.category; // backend must return category
              const container = document.querySelector(`#${updatedCategory} .row`);

              if (container) {
                fetch(`/api/eyeglasses/${updatedCategory}`)
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      container.innerHTML = "";
                      data.products.forEach(product => {
                        const card = document.createElement("div");
                        card.className = "col-md-3 mb-4";
                        card.innerHTML = `
                          <div class="card product-card h-100">
                            <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                              <h5 class="card-title">${product.name}</h5>
                              ${
                                product.category === "kidsEyeglasses"
                                  ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>`
                                  : ""
                              }
                              <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                              <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                              <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                                <i class="fas fa-eye"></i> View
                              </button>
                              <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                                <i class="fas fa-edit"></i> Edit
                              </button>
                              <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </div>
                          </div>
                        `;
                        container.appendChild(card);
                      });
                    }
                  })
                  .catch(err => console.error("Error refreshing products:", err));
              }
            } else {
              alert("❌ Failed to update product.");
            }
          } catch (err) {
            console.error("Error updating product:", err);
          }
        });

        //  DELETE functionality
        let deleteProductId = null;
        const deleteModalEl = document.getElementById("deleteEyeglassProductModal");
        const deleteModal = new bootstrap.Modal(deleteModalEl);
        const confirmDeleteBtn = document.getElementById("confirmDeleteEyeglassBtn");

        // Event delegation for delete buttons
        const eyeglassesContainer = document.getElementById("eyeglasses-products");

        eyeglassesContainer?.addEventListener("click", (e) => {
          const btn = e.target.closest(".delete-product-btn");
          if (!btn) return;

          deleteProductId = btn.dataset.id;
          deleteModal.show();
        });

        // Confirm deletion
        confirmDeleteBtn.addEventListener("click", async () => {
          if (!deleteProductId) return;

          try {
            const res = await fetch(`/api/eyeglasses/delete/${deleteProductId}`, {
              method: "DELETE",
            });
            const data = await res.json();

            if (data.success) {
              deleteModal.hide();
              deleteProductId = null;

              // Refresh product list
              const categories = ["metalFrames", "regularGlasses", "brandedFrames", "kidsEyeglasses"];
              for (const category of categories) {
                const container = document.querySelector(`#${category} .row`);
                if (!container) continue;

                const res = await fetch(`/api/eyeglasses/${category}`);
                const data = await res.json();
                if (data.success) {
                  container.innerHTML = "";
                  data.products.forEach(product => {
                    const card = document.createElement("div");
                    card.className = "col-md-3 mb-4";
                    card.innerHTML = `
                      <div class="card product-card h-100">
                        <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                        <div class="card-body">
                          <h5 class="card-title">${product.name}</h5>
                          ${
                            product.category === "kidsEyeglasses" 
                              ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>` 
                              : ""
                          }
                          <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                          <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                          <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                            <i class="fas fa-eye"></i> View
                          </button>
                          <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                            <i class="fas fa-trash"></i> Delete
                          </button>
                        </div>
                      </div>
                    `;

                    container.appendChild(card);
                  });
                }
              }
            }
          } catch (err) {
            console.error("Error deleting product:", err);
          }
        });
      });
    </script>
    
    <!-- ========================= SUNGLASSES PAGE ======================= -->
    <!-- Products Management - Sunglasses -->
    <section id="sunglasses-products" class="content-section">
      <h2>Sunglasses Products</h2>
      <ul class="nav nav-tabs mb-3" id="sunglassesTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#metalSunglasses">Metal Sunglasses</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#regularSunglasses">Regular Sunglasses</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#brandedSunglasses">Branded Sunglasses</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#kidsSunglasses">Kids Section</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="metalSunglasses">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Metal Sunglasses Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_K3r0lb_TcuJ8UdT2T0GNAOpcNGgmObsrGHd1ZkSWqgPNm_ZdTfOc5Vfl9b9ZAjZgTs0&usqp=CAU" class="card-img-top" alt="Classic Aviator Sunglasses">
                    <div class="card-body">
                      <h5 class="card-title">Classic Aviator Sunglasses</h5>
                      <p class="card-text"><strong>ID:</strong> SM001</p>
                      <p class="card-text"><strong>Price:</strong> $150.00</p>
                      <p class="card-text"><strong>Stock:</strong> 45</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="regularSunglasses">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Regular Sunglasses Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQoGqoFeFvIwEs754-MOs7NHfa6RG7WW9_g2McMDzx9iMssDlyLo5jtL_i-n5AxuTmDxzE&usqp=CAU" class="card-img-top" alt="Sporty Wrap-around Sunglasses">
                    <div class="card-body">
                      <h5 class="card-title">Sporty Wrap-around Sunglasses</h5>
                      <p class="card-text"><strong>ID:</strong> RS001</p>
                      <p class="card-text"><strong>Price:</strong> $85.00</p>
                      <p class="card-text"><strong>Stock:</strong> 60</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="brandedSunglasses">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Branded Sunglasses Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1R1DnJvYPZ7sQ9gU7Bul--y-VZa4dED0bBHL3yUKcMxsaS7skwYKJ5JvBtrYpjw7vpUo&usqp=CAU" class="card-img-top" alt="Oakley Holbrook">
                    <div class="card-body">
                      <h5 class="card-title">Oakley Holbrook</h5>
                      <p class="card-text"><strong>ID:</strong> BS001</p>
                      <p class="card-text"><strong>Brand:</strong> Oakley</p>
                      <p class="card-text"><strong>Price:</strong> $200.00</p>
                      <p class="card-text"><strong>Stock:</strong> 20</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="kidsSunglasses">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Kids Sunglasses Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1R1DnJvYPZ7sQ9gU7Bul--y-VZa4dED0bBHL3yUKcMxsaS7skwYKJ5JvBtrYpjw7vpUo&usqp=CAU" class="card-img-top" alt="Fun Animal Print Sunglasses">
                    <div class="card-body">
                      <h5 class="card-title">Fun Animal Print Sunglasses</h5>
                      <p class="card-text"><strong>ID:</strong> KS001</p>
                      <p class="card-text"><strong>Age Group:</strong> 3-8</p>
                      <p class="card-text"><strong>Price:</strong> $40.00</p>
                      <p class="card-text"><strong>Stock:</strong> 35</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Add Sunglasses Product Modal -->
    <div class="modal fade" id="addSunglassesModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form id="addSunglassesForm" class="needs-validation" enctype="multipart/form-data" novalidate autocomplete="off">
          <div class="modal-content">
            <div class="modal-header text-white bg-primary">
              <h5 class="modal-title">Add Sunglasses Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <input type="hidden" name="category" id="sunglassesCategory">

              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" name="name" class="form-control" required>
                <div class="invalid-feedback">Product name is required.</div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
              </div>

              <!-- Price -->
              <div class="mb-3">
                <label class="form-label">Price</label>
                <input type="number" name="price" class="form-control" min="1" step="any" required>
                <div class="invalid-feedback">Price is required and must be greater than zero.</div>
              </div>

              <!-- Stock -->
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input type="number" name="stock" class="form-control" min="1" step="1" required>
                <div class="invalid-feedback">Stock is required and must be greater than zero.</div>
              </div>

              <!-- Age Group (Kids only) -->
              <div class="mb-3 d-none" id="sunglassesAgeGroupWrapper">
                <label class="form-label">Age Group</label>
                <select name="ageGroup" class="form-control" required>
                  <option value="3-5 years">3–5 Years</option>
                  <option value="6-8 years">6–8 Years</option>
                  <option value="9-12 years">9–12 Years</option>
                  <option value="13-15 years">13–15 Years</option>
                </select>
              </div>

              <!-- Main Image -->
              <div class="mb-3">
                <label class="form-label">Main Image</label>
                <input type="file" name="mainImage" class="form-control" accept="image/*" required>
                <div class="invalid-feedback">Main product image is required.</div>
              </div>

              <!-- Sub Images -->
              <div class="mb-3">
                <label class="form-label">Sub Images (up to 3)</label>
                <input type="file" name="subImages" class="form-control" accept="image/*" multiple>
              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save Product</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- Sunglasses Confirmation Modal -->
    <div class="modal fade" id="sunglassesConfirmationModal" tabindex="-1">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content rounded-2" style="width: 350px; height: 200px; margin: auto;">
          <div class="modal-body d-flex flex-column justify-content-center align-items-center text-center">
            <p id="sunglassesConfirmationMessage" class="fs-4"></p>
          </div>
        </div>
      </div>
    </div>
    <!-- View Sunglass Modal -->
    <div class="modal fade" id="viewSunglassModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Product Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewSunglassModalBody">
            <!-- Product details will be dynamically injected here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Sunglass Product Modal -->
    <div class="modal fade" id="editSunglassProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info">
            <h5 class="modal-title">Edit Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editSunglassForm" autocomplete="off" novalidate>
              <input type="hidden" id="editSunglassProductId" name="productId">

              <div class="mb-3">
                <label for="editSunglassName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="editSunglassName" name="name" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editSunglassPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="editSunglassPrice" name="price" min="1" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editSunglassStock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="editSunglassStock" name="stock" min="1" autocomplete="off" required>
              </div>

              <div class="mb-3 d-none" id="editSunglassAgeGroupWrapper">
                <label for="editSunglassAgeGroup" class="form-label">Age Group</label>
                <select class="form-select" id="editSunglassAgeGroup" name="ageGroup">
                  <option value="3-5 years">3-5 Years</option>
                  <option value="6-8 years">6-8 Years</option>
                  <option value="9-12 years">9-12 Years</option>
                  <option value="13-15 years">13-15 Years</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" form="editSunglassForm" class="btn btn-info">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Delete Sunglass Modal -->
    <div class="modal fade" id="deleteSunglassProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this Product?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteSunglassBtn" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Sunglasses Product JS -->
    <script>
      // Add Product (Sunglasses)
      document.addEventListener("DOMContentLoaded", () => {
        const addButtons = document.querySelectorAll("#sunglasses-products .btn-primary");

        const categoryInput = document.getElementById("sunglassesCategory");
        const addProductForm = document.getElementById("addSunglassesForm");
        const ageGroupWrapper = document.getElementById("sunglassesAgeGroupWrapper");
        const addProductModalEl = document.getElementById("addSunglassesModal");

        // Map which button belongs to which category (matches your sunglasses section IDs)
        const categories = {
          metalSunglasses: "metalSunglasses",
          regularSunglasses: "regularSunglasses",
          brandedSunglasses: "brandedSunglasses",
          kidsSunglasses: "kidsSunglasses",
        };

        addButtons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            // Reset form *before opening modal*
            addProductForm.reset();

            const tabId = e.target.closest(".tab-pane").getAttribute("id");
            const category = categories[tabId];

            categoryInput.value = category;

            // Show/hide Age Group for Kids section
            if (category === "kidsSunglasses") {
              ageGroupWrapper.classList.remove("d-none");
            } else {
              ageGroupWrapper.classList.add("d-none");
            }

            new bootstrap.Modal(document.getElementById("addSunglassesModal")).show();
          });
        });

        // Reset form when modal is CLOSED (cancel, click outside, etc.)
        addProductModalEl.addEventListener("hidden.bs.modal", () => {
          addProductForm.reset();
          categoryInput.value = "";
          ageGroupWrapper.classList.add("d-none");
        });

        // Form submit
        addProductForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Form Validation
          let valid = true;

          // Clear old errors
          addProductForm.querySelectorAll(".error-message").forEach(el => el.remove());

          const name = addProductForm.querySelector("[name='name']");
          const price = addProductForm.querySelector("[name='price']");
          const stock = addProductForm.querySelector("[name='stock']");
          const mainImage = addProductForm.querySelector("[name='mainImage']");

          // product name
          if (!name.value.trim()) {
            showError(name, "Product name is required");
            valid = false;
          }

          // price
          if (!price.value || price.value <= 0) {
            showError(price, "Price is required and must be greater than zero.");
            valid = false;
          }

          // stock
          if (!stock.value || stock.value <= 0) {
            showError(stock, "Stock is required and must be greater than zero.");
            valid = false;
          }

          // main image
          if (!mainImage.files || mainImage.files.length === 0) {
            showError(mainImage, "Main image is required");
            valid = false;
          }

          if (!valid) return; // stop here if validation fails

          const formData = new FormData(addProductForm);

          const res = await fetch("/api/sunglasses/add", {
            method: "POST",
            body: formData,
          });

          const data = await res.json();

          // Close add product modal if open
          const addModal = bootstrap.Modal.getInstance(document.getElementById("addSunglassesModal"));
          if (addModal) addModal.hide();

          // Show confirmation modal
          const confirmationMessage = document.getElementById("sunglassesConfirmationMessage");
          const confirmationModalEl = document.getElementById("sunglassesConfirmationModal");
          const confirmationModal = new bootstrap.Modal(confirmationModalEl);

          if (data.success) {
            confirmationMessage.innerHTML = `<i class="fas fa-check-circle text-primary"></i> Product added successfully!`;
            confirmationModal.show();

            // Auto reload after short delay
            setTimeout(() => location.reload(), 3000);
          } else {
            confirmationMessage.innerText = "❌ Error adding product.";
            confirmationModal.show();
          }
        });

        // helper function to show errors
        function showError(input, message) {
          // avoid duplicate error
          if (input.parentNode.querySelector(".error-message")) return;

          const error = document.createElement("div");
          error.className = "error-message text-danger small mt-1";
          error.innerText = message;
          input.parentNode.appendChild(error);

          // Remove error when user focuses OR types
          function clearError() {
            const existingError = input.parentNode.querySelector(".error-message");
            if (existingError) existingError.remove();
            input.removeEventListener("focus", clearError);
            input.removeEventListener("input", clearError);
          }

          input.addEventListener("focus", clearError);
          input.addEventListener("input", clearError);
        }
      });

      // Get/Render/View/Edit/Delete products for Sunglasses
      document.addEventListener("DOMContentLoaded", () => {
        const categories = ["metalSunglasses", "regularSunglasses", "brandedSunglasses", "kidsSunglasses"];

        categories.forEach(category => {
          fetch(`/api/sunglasses/${category}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const container = document.querySelector(`#${category} .row`);
                if (!container) return;
                container.innerHTML = ""; // clear demo product

                  data.products.forEach(product => {
                  const card = document.createElement("div");
                  card.className = "col-md-3 mb-4";
                  card.innerHTML = `
                    <div class="card product-card h-100">
                      <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                      <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        ${
                          product.category === "kidsSunglasses" 
                            ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>` 
                            : ""
                        }
                        <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                        <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                      </div>
                      <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                          <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  `;
                  container.appendChild(card);
                });
              }
            });
        });

        // Scope event delegation to sunglasses-products section to avoid conflicts
        const sunglassesSection = document.getElementById("sunglasses-products");

        // View/Edit/Delete buttons (delegated)
        sunglassesSection.addEventListener("click", async (e) => {
          // VIEW
          const viewBtn = e.target.closest(".view-product-btn");
          if (viewBtn) {
            e.stopPropagation(); // prevent eyeglasses handlers from also firing
            const productId = viewBtn.dataset.id;

            // Fetch product details by ID
            try {
              const res = await fetch(`/api/sunglasses/product/${productId}`);
              const product = await res.json();

              if (!product || !product.success) return;

              const p = product.product; // assume API returns { success: true, product: {...} }

              const modalBody = document.getElementById("viewSunglassModalBody");
              modalBody.innerHTML = `
                <div class="row">
                  <div class="col-md-5 text-center">
                    <img src="${p.mainImage}" class="img-fluid rounded mb-3" alt="${p.name}">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                      ${
                        p.subImages && p.subImages.length
                          ? p.subImages.map(img => `<img src="${img}" class="img-thumbnail" style="width:80px; height:80px;">`).join("")
                          : ""
                      }
                    </div>
                  </div>
                  <div class="col-md-7">
                    <h4>${p.name}</h4>
                    <p>${p.description || "No description available."}</p>
                    <p><strong>Price:</strong> Rs. ${p.price}</p>
                    <p><strong>Stock:</strong> ${p.stock}</p>
                    ${
                      p.category === "kidsSunglasses"
                        ? `<p><strong>Age Group:</strong> ${p.ageGroup}</p>`
                        : ""
                    }
                  </div>
                </div>
              `;

              new bootstrap.Modal(document.getElementById("viewSunglassModal")).show();
            } catch (err) {
              console.error("Error fetching product for view:", err);
            }
            return;
          }

          // EDIT
          const editBtn = e.target.closest(".edit-product-btn");
          if (editBtn) {
            e.stopPropagation();
            const productId = editBtn.dataset.id;

            try {
              const res = await fetch(`/api/sunglasses/product/${productId}`);
              const data = await res.json();

              if (data.success) {
                const p = data.product;

                // populate edit modal
                document.getElementById("editSunglassProductId").value = p._id;
                document.getElementById("editSunglassName").value = p.name || "";
                document.getElementById("editSunglassPrice").value = p.price || "";
                document.getElementById("editSunglassStock").value = p.stock || "";

                if (p.category === "kidsSunglasses") {
                  document.getElementById("editSunglassAgeGroupWrapper").classList.remove("d-none");
                  document.getElementById("editSunglassAgeGroup").value = p.ageGroup || "";
                } else {
                  document.getElementById("editSunglassAgeGroupWrapper").classList.add("d-none");
                  document.getElementById("editSunglassAgeGroup").value = "";
                }

                new bootstrap.Modal(document.getElementById("editSunglassProductModal")).show();
              }
            } catch (err) {
              console.error("Error fetching product for edit:", err);
            }
            return;
          }
        });

        // EDIT product logic
        const editModalEl = document.getElementById("editSunglassProductModal");
        const editModal = new bootstrap.Modal(editModalEl);
        const editForm = document.getElementById("editSunglassForm");
        const editProductIdEl = document.getElementById("editSunglassProductId");
        const editName = document.getElementById("editSunglassName");
        const editPrice = document.getElementById("editSunglassPrice");
        const editStock = document.getElementById("editSunglassStock");
        const editAgeGroupWrapper = document.getElementById("editSunglassAgeGroupWrapper");
        const editAgeGroup = document.getElementById("editSunglassAgeGroup");

        // Helper functions for error messages
        function showErrorEdit(inputEl, message) {
          let errorEl = inputEl.parentElement.querySelector(".error-text");
          if (!errorEl) {
            errorEl = document.createElement("div");
            errorEl.className = "error-text text-danger mt-1";
            inputEl.parentElement.appendChild(errorEl);
          }
          errorEl.textContent = message;
        }

        function clearErrorEdit(inputEl) {
          const errorEl = inputEl.parentElement.querySelector(".error-text");
          if (errorEl) errorEl.textContent = "";
        }

        // Clear form + errors
        function resetEditForm() {
          editForm.reset();
          [editName, editPrice, editStock, editAgeGroup].forEach(clearErrorEdit);
          editProductIdEl.value = "";
          editAgeGroupWrapper.classList.add("d-none");
        }

        // Remove error when user focuses or types
        [editName, editPrice, editStock, editAgeGroup].forEach(input => {
          input.addEventListener("focus", () => clearErrorEdit(input));
          input.addEventListener("input", () => clearErrorEdit(input));
        });

        // Reset form whenever modal closes (Cancel or after Save)
        editModalEl.addEventListener("hidden.bs.modal", resetEditForm);

        // Handle save changes
        editForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          let isValid = true;

          // Validate Name
          if (!editName.value.trim()) {
            showErrorEdit(editName, "Name is required");
            isValid = false;
          } else {
            clearErrorEdit(editName);
          }

          // Validate Price
          if (editPrice.value === "" || isNaN(editPrice.value) || Number(editPrice.value) < 0) {
            showErrorEdit(editPrice, "Price must be a valid non-negative number");
            isValid = false;
          } else {
            clearErrorEdit(editPrice);
          }

          // Validate Stock
          if (editStock.value === "" || isNaN(editStock.value) || Number(editStock.value) < 0) {
            showErrorEdit(editStock, "Stock must be a valid non-negative number");
            isValid = false;
          } else {
            clearErrorEdit(editStock);
          }

          if (!isValid) return; // stop if validation fails

          const updatedProduct = {
            name: editName.value.trim(),
            price: Number(editPrice.value),
            stock: Number(editStock.value),
          };

          // only send ageGroup if the field is visible
          if (!editAgeGroupWrapper.classList.contains("d-none")) {
            updatedProduct.ageGroup = editAgeGroup.value;
          }

          try {
            const res = await fetch(`/api/sunglasses/update/${editProductIdEl.value}`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedProduct),
            });

            const data = await res.json();

            if (data.success) {
              const activeModal = bootstrap.Modal.getInstance(editModalEl);
              if (activeModal) activeModal.hide();

              // Refresh only products inside categories
              const updatedCategory = data.product.category; // backend must return category
              const container = document.querySelector(`#${updatedCategory} .row`);

              if (container) {
                fetch(`/api/sunglasses/${updatedCategory}`)
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      container.innerHTML = "";
                      data.products.forEach(product => {
                        const card = document.createElement("div");
                        card.className = "col-md-3 mb-4";
                        card.innerHTML = `
                          <div class="card product-card h-100">
                            <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                              <h5 class="card-title">${product.name}</h5>
                              ${
                                product.category === "kidsSunglasses"
                                  ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>`
                                  : ""
                              }
                              <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                              <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                              <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                                <i class="fas fa-eye"></i> View
                              </button>
                              <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                                <i class="fas fa-edit"></i> Edit
                              </button>
                              <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </div>
                          </div>
                        `;
                        container.appendChild(card);
                      });
                    }
                  })
                  .catch(err => console.error("Error refreshing products:", err));
              }
            } else {
              alert("❌ Failed to update product.");
            }
          } catch (err) {
            console.error("Error updating product:", err);
          }
        });

        // Sunglasses DELETE functionality
        let deleteSunglassId = null;
        const deleteSunglassModalEl = document.getElementById("deleteSunglassProductModal");
        const deleteSunglassModal = new bootstrap.Modal(deleteSunglassModalEl);
        const confirmDeleteSunglassBtn = document.getElementById("confirmDeleteSunglassBtn");

        // Event delegation for delete buttons
        const sunglassesContainer = document.getElementById("sunglasses-products");

        sunglassesContainer?.addEventListener("click", (e) => {
          const btn = e.target.closest(".delete-product-btn");
          if (!btn) return;

          deleteSunglassId = btn.dataset.id;
          deleteSunglassModal.show();
        });

        // Confirm deletion
        confirmDeleteSunglassBtn.addEventListener("click", async () => {
          if (!deleteSunglassId) return;

          try {
            const res = await fetch(`/api/sunglasses/delete/${deleteSunglassId}`, { method: "DELETE" });
            const data = await res.json();
 
            if (data.success) {
              deleteSunglassModal.hide();
              deleteSunglassId = null;

              // Refresh product list for all 4 categories
              const categories = ["metalSunglasses", "regularSunglasses", "brandedSunglasses", "kidsSunglasses"];
              for (const category of categories) {
                const container = document.querySelector(`#${category} .row`);
                if (!container) continue;

                const res = await fetch(`/api/sunglasses/${category}`);
                const data = await res.json();
                if (data.success) {
                  container.innerHTML = "";
                  data.products.forEach(product => {
                    const card = document.createElement("div");
                    card.className = "col-md-3 mb-4";
                    card.innerHTML = `
                      <div class="card product-card h-100">
                        <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                        <div class="card-body">
                          <h5 class="card-title">${product.name}</h5>
                          ${
                            product.category === "kidsSunglasses"
                              ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>`
                              : ""
                          }
                          <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                          <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                          <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                            <i class="fas fa-eye"></i> View
                          </button>
                          <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                            <i class="fas fa-trash"></i> Delete
                          </button>
                        </div>
                      </div>
                    `;
                    container.appendChild(card);
                  });
                }
              }
            }
          } catch (err) {
            console.error("Error deleting sunglasses product:", err);
          }
        });
      });
    </script>

    <!-- ========================= WATCHES PAGE ======================= -->
    <!-- Products Management - Watches -->
    <section id="watches-products" class="content-section">
      <h2>Watches Products</h2>
      <ul class="nav nav-tabs mb-3" id="watchesTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gentsWatches">Gents Watches</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ladiesWatches">Ladies Watches</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#premiumWatches">Premium Watches</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#kidsWatches">Kids Section</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="gentsWatches">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Gents Watches Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://images.pexels.com/photos/190819/pexels-photo-190819.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500" class="card-img-top" alt="Casio Edifice Classic">
                    <div class="card-body">
                      <h5 class="card-title">Casio Edifice Classic</h5>
                      <p class="card-text"><strong>ID:</strong> GW001</p>
                      <p class="card-text"><strong>Brand:</strong> Casio</p>
                      <p class="card-text"><strong>Price:</strong> $250.00</p>
                      <p class="card-text"><strong>Stock:</strong> 18</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="ladiesWatches">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Ladies Watches Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwD0S423Jv3AZjh0WwfjWy2nxY-xShQs7b3UwgPwy2S0aDs4dbt-D_gBim5WSCQ-9qro4&usqp=CAU" class="card-img-top" alt="Coach Park Stainless Steel">
                    <div class="card-body">
                      <h5 class="card-title">Coach Park Stainless Steel</h5>
                      <p class="card-text"><strong>ID:</strong> LW001</p>
                      <p class="card-text"><strong>Brand:</strong> Coach</p>
                      <p class="card-text"><strong>Price:</strong> $180.00</p>
                      <p class="card-text"><strong>Stock:</strong> 22</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="premiumWatches">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Premium Watches Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSLD4LmWXi_Enuv9p0nzHFOvTP5Ur81k6IIwJs0F8KVhMKRXxrqoaMVlrFxtBbXtWVi56g&usqp=CAU" class="card-img-top" alt="Rado Integral Ceramic Black">
                    <div class="card-body">
                      <h5 class="card-title">Rado Integral Ceramic Black</h5>
                      <p class="card-text"><strong>ID:</strong> BW001</p>
                      <p class="card-text"><strong>Brand:</strong> Rado</p>
                      <p class="card-text"><strong>Price:</strong> $1200.00</p>
                      <p class="card-text"><strong>Stock:</strong> 5</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="kidsWatches">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Kids Watches Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwD0S423Jv3AZjh0WwfjWy2nxY-xShQs7b3UwgPwy2S0aDs4dbt-D_gBim5WSCQ-9qro4&usqp=CAU" class="card-img-top" alt="Fun Cartoon Watch">
                    <div class="card-body">
                      <h5 class="card-title">Fun Cartoon Watch</h5>
                      <p class="card-text"><strong>ID:</strong> KW001</p>
                      <p class="card-text"><strong>Age Group:</strong> 3-8</p>
                      <p class="card-text"><strong>Price:</strong> $30.00</p>
                      <p class="card-text"><strong>Stock:</strong> 50</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Add Watches Product Modal -->
    <div class="modal fade" id="addWatchesModal" tabindex="-1">
      <div class="modal-dialog modal-lg">   
        <form id="addWatchesForm" class="needs-validation" enctype="multipart/form-data" novalidate autocomplete="off">
          <div class="modal-content">
            <div class="modal-header text-white bg-primary">
              <h5 class="modal-title">Add Watches Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <input type="hidden" name="category" id="watchesCategory">

              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" name="name" class="form-control" required>
                <div class="invalid-feedback">Product name is required.</div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
              </div>

              <!-- Price -->
              <div class="mb-3">
                <label class="form-label">Price</label>
                <input type="number" name="price" class="form-control" min="1" step="any" required>
                <div class="invalid-feedback">Price is required and must be greater than zero.</div>
              </div>

              <!-- Stock -->
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input type="number" name="stock" class="form-control" min="1" step="1" required>
                <div class="invalid-feedback">Stock is required and must be greater than zero.</div>
              </div>

              <!-- Age Group (Kids only) -->
              <div class="mb-3 d-none" id="watchAgeGroupWrapper">
                <label class="form-label">Age Group</label>
                <select name="ageGroup" class="form-control" required>
                  <option value="3-5 years">3–5 Years</option>
                  <option value="6-8 years">6–8 Years</option>
                  <option value="9-12 years">9–12 Years</option>
                  <option value="13-15 years">13–15 Years</option>
                </select>
              </div>

              <!-- Main Image -->
              <div class="mb-3">
                <label class="form-label">Main Image</label>
                <input type="file" name="mainImage" class="form-control" accept="image/*" required>
                <div class="invalid-feedback">Main product image is required.</div>
              </div>

              <!-- Sub Images -->
              <div class="mb-3">
                <label class="form-label">Sub Images (up to 3)</label>
                <input type="file" name="subImages" class="form-control" accept="image/*" multiple>
              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save Product</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- Watches Confirmation Modal -->
    <div class="modal fade" id="watchesConfirmationModal" tabindex="-1">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content rounded-2" style="width: 350px; height: 200px; margin: auto;">
          <div class="modal-body d-flex flex-column justify-content-center align-items-center text-center">
            <p id="watchesConfirmationMessage" class="fs-4"></p>
          </div>
        </div>
      </div>
    </div>
    <!-- View Watch Modal -->
    <div class="modal fade" id="viewWatchModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Product Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewWatchModalBody">
            <!-- Product details will be dynamically injected here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Watch Product Modal -->
    <div class="modal fade" id="editWatchProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info">
            <h5 class="modal-title">Edit Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editWatchForm" autocomplete="off" novalidate>
              <input type="hidden" id="editWatchProductId" name="productId">

              <div class="mb-3">
                <label for="editWatchName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="editWatchName" name="name" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editWatchPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="editWatchPrice" name="price" min="1" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editWatchStock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="editWatchStock" name="stock" min="1" autocomplete="off" required>
              </div>

              <div class="mb-3 d-none" id="editWatchAgeGroupWrapper">
                <label for="editWatchAgeGroup" class="form-label">Age Group</label>
                <select class="form-select" id="editWatchAgeGroup" name="ageGroup">
                  <option value="3-5 years">3-5 Years</option>
                  <option value="6-8 years">6-8 Years</option>
                  <option value="9-12 years">9-12 Years</option>
                  <option value="13-15 years">13-15 Years</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" form="editWatchForm" class="btn btn-info">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Delete Watch Modal -->
    <div class="modal fade" id="deleteWatchProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this Product?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteWatchBtn" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Watches Product JS -->
    <script>
      // ================== Watches Product JS (Add modal + validation) ==================
      document.addEventListener("DOMContentLoaded", () => {
        const addButtons = document.querySelectorAll("#watches-products .btn-primary");

        const categoryInput = document.getElementById("watchesCategory");
        const addProductForm = document.getElementById("addWatchesForm");
        const watchAgeGroupWrapper = document.getElementById("watchAgeGroupWrapper");
        const addProductModalEl = document.getElementById("addWatchesModal");

        // Map which tab id -> category (include alias for backward compatibility)
        const categories = {
          gentsWatches: "gentsWatches",
          ladiesWatches: "ladiesWatches",
          premiumWatches: "premiumWatches",
          kidsWatches: "kidsWatches",
          brandedWatches: "premiumWatches" // alias if your HTML still uses brandedWatches
        };

        addButtons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            // Reset form *before opening modal*
            addProductForm.reset();

            const tabPane = e.target.closest(".tab-pane");
            if (!tabPane) return;
            const tabId = tabPane.getAttribute("id");
            const category = categories[tabId] || tabId; // fallback to tabId if mapping missing

            categoryInput.value = category;

            // Show/hide Age Group for Kids section
            if (category === "kidsWatches") {
              watchAgeGroupWrapper.classList.remove("d-none");
            } else {
              watchAgeGroupWrapper.classList.add("d-none");
            }

            new bootstrap.Modal(document.getElementById("addWatchesModal")).show();
          });
        });

        // Reset form when modal is CLOSED (cancel, click outside, etc.)
        addProductModalEl.addEventListener("hidden.bs.modal", () => {
          addProductForm.reset();
          categoryInput.value = "";
          if (watchAgeGroupWrapper) watchAgeGroupWrapper.classList.add("d-none");
        });

        // Form submit
        addProductForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Form Validation
          let valid = true;

          // Clear old errors
          addProductForm.querySelectorAll(".error-message").forEach(el => el.remove());

          const name = addProductForm.querySelector("[name='name']");
          const price = addProductForm.querySelector("[name='price']");
          const stock = addProductForm.querySelector("[name='stock']");
          const mainImage = addProductForm.querySelector("[name='mainImage']");

          // product name
          if (!name.value.trim()) {
            showError(name, "Product name is required");
            valid = false;
          }

          // price
          if (!price.value || Number(price.value) <= 0) {
            showError(price, "Price is required and must be greater than zero.");
            valid = false;
          }

          // stock
          if (!stock.value || Number(stock.value) <= 0) {
            showError(stock, "Stock is required and must be greater than zero.");
            valid = false;
          }

          // main image
          if (!mainImage.files || mainImage.files.length === 0) {
            showError(mainImage, "Main image is required");
            valid = false;
          }

          if (!valid) return; // stop here if validation fails

          const formData = new FormData(addProductForm);

          try {
            const res = await fetch("/api/watches/add", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();

            // Close add product modal if open
            const addModal = bootstrap.Modal.getInstance(document.getElementById("addWatchesModal"));
            if (addModal) addModal.hide();

            // Show confirmation modal
            const confirmationMessage = document.getElementById("watchesConfirmationMessage");
            const confirmationModalEl = document.getElementById("watchesConfirmationModal");
            const confirmationModal = new bootstrap.Modal(confirmationModalEl);

            if (data.success) {
              confirmationMessage.innerHTML = `<i class="fas fa-check-circle text-primary"></i> Product added successfully!`;
              confirmationModal.show();

              // Auto reload after short delay
              setTimeout(() => location.reload(), 3000);
            } else {
              confirmationMessage.innerText = "❌ Error adding product.";
              confirmationModal.show();
            }
          } catch (err) {
            console.error("Error adding watch:", err);
            const confirmationMessage = document.getElementById("watchesConfirmationMessage");
            const confirmationModalEl = document.getElementById("watchesConfirmationModal");
            const confirmationModal = new bootstrap.Modal(confirmationModalEl);
            confirmationMessage.innerText = "❌ Error adding product.";
            confirmationModal.show();
          }
        });

        // helper function to show errors
        function showError(input, message) {
          // avoid duplicate error
          if (input.parentNode.querySelector(".error-message")) return;

          const error = document.createElement("div");
          error.className = "error-message text-danger small mt-1";
          error.innerText = message;
          input.parentNode.appendChild(error);

          // Remove error when user focuses OR types
          function clearError() {
            const existingError = input.parentNode.querySelector(".error-message");
            if (existingError) existingError.remove();
            input.removeEventListener("focus", clearError);
            input.removeEventListener("input", clearError);
          }

          input.addEventListener("focus", clearError);
          input.addEventListener("input", clearError);
        }
      });

      // ================== Fetch / View / Edit / Delete watches (dashboard) ==================
      document.addEventListener("DOMContentLoaded", () => {
        const categories = ["gentsWatches", "ladiesWatches", "premiumWatches", "kidsWatches"];

        categories.forEach(category => {
          fetch(`/api/watches/${category}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const container = document.querySelector(`#${category} .row`);
                if (!container) return;
                container.innerHTML = ""; // clear demo product

                data.products.forEach(product => {
                  const card = document.createElement("div");
                  card.className = "col-md-3 mb-4";
                  card.innerHTML = `
                    <div class="card product-card h-100">
                      <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                      <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        ${ product.category === "kidsWatches" ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>` : "" }
                        <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                        <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                      </div>
                      <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                          <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  `;
                  container.appendChild(card);
                });
              }
            })
            .catch(err => console.error(`Error fetching category ${category}:`, err));
        });

        // Handle View button click using event delegation
        document.addEventListener("click", (e) => {
          const btn = e.target.closest(".view-product-btn");
          if (!btn) return;

          const productId = btn.dataset.id;

          // Fetch product details by ID
          fetch(`/api/watches/product/${productId}`)
            .then(res => res.json())
            .then(product => {
              if (!product || !product.success) return;

              const p = product.product; // assume API returns { success: true, product: {...} }

              const modalBody = document.getElementById("viewWatchModalBody");
              modalBody.innerHTML = `
                <div class="row">
                  <div class="col-md-5 text-center">
                    <img src="${p.mainImage}" class="img-fluid rounded mb-3" alt="${p.name}">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                      ${
                        p.subImages && p.subImages.length
                          ? p.subImages.map(img => `<img src="${img}" class="img-thumbnail" style="width:80px; height:80px;">`).join("")
                          : ""
                      }
                    </div>
                  </div>
                  <div class="col-md-7">
                    <h4>${p.name}</h4>
                    <p>${p.description || "No description available."}</p>
                    <p><strong>Price:</strong> Rs. ${p.price}</p>
                    <p><strong>Stock:</strong> ${p.stock}</p>
                    ${
                      p.category === "kidsWatches"
                        ? `<p><strong>Age Group:</strong> ${p.ageGroup}</p>`
                        : ""
                    }
                  </div>
                </div>
              `;

              new bootstrap.Modal(document.getElementById("viewWatchModal")).show();
            })
            .catch(err => console.error("Error fetching watch details:", err));
        });

        // EDIT PRODUCT
        const editModalEl = document.getElementById("editWatchProductModal");
        const editModal = new bootstrap.Modal(editModalEl);
        const editForm = document.getElementById("editWatchForm");
        const editProductId = document.getElementById("editWatchProductId");
        const editName = document.getElementById("editWatchName");
        const editPrice = document.getElementById("editWatchPrice");
        const editStock = document.getElementById("editWatchStock");
        const editAgeGroupWrapper = document.getElementById("editWatchAgeGroupWrapper");
        const editAgeGroup = document.getElementById("editWatchAgeGroup");

        // Helper functions for error messages (scoped to edit)
        function showEditError(inputEl, message) {
          let errorEl = inputEl.parentElement.querySelector(".error-text");
          if (!errorEl) {
            errorEl = document.createElement("div");
            errorEl.className = "error-text text-danger mt-1";
            inputEl.parentElement.appendChild(errorEl);
          }
          errorEl.textContent = message;
        }

        function clearEditError(inputEl) {
          const errorEl = inputEl.parentElement.querySelector(".error-text");
          if (errorEl) errorEl.textContent = "";
        }

        // Clear form + errors
        function resetEditForm() {
          editForm.reset();
          [editName, editPrice, editStock, editAgeGroup].forEach(clearEditError);
          editProductId.value = "";
          if (editAgeGroupWrapper) editAgeGroupWrapper.classList.add("d-none");
        }

        // Remove error when user focuses or types
        [editName, editPrice, editStock, editAgeGroup].forEach(input => {
          if (!input) return;
          input.addEventListener("focus", () => clearEditError(input));
          input.addEventListener("input", () => clearEditError(input));
        });

        // Reset form whenever modal closes (Cancel or after Save)
        if (editModalEl) editModalEl.addEventListener("hidden.bs.modal", resetEditForm);

        // Open modal and load product data for edit
        document.addEventListener("click", async (e) => {
          const btn = e.target.closest(".edit-product-btn"); // edit button
          if (!btn) return;

          const productId = btn.dataset.id;

          try {
            const res = await fetch(`/api/watches/product/${productId}`);
            const data = await res.json();

            if (data.success) {
              const p = data.product;

              editProductId.value = p._id;
              editName.value = p.name;
              editPrice.value = p.price;
              editStock.value = p.stock;

              if (p.category === "kidsWatches") {
                editAgeGroupWrapper.classList.remove("d-none");
                editAgeGroup.value = p.ageGroup || "";
              } else {
                editAgeGroupWrapper.classList.add("d-none");
                editAgeGroup.value = "";
              }

              editModal.show();
            }
          } catch (err) {
            console.error("Error fetching product for edit:", err);
          }
        });

        // Handle save changes
        editForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          let isValid = true;

          // Validate Name
          if (!editName.value.trim()) {
            showEditError(editName, "Name is required");
            isValid = false;
          } else {
            clearEditError(editName);
          }

          // Validate Price
          if (editPrice.value === "" || isNaN(editPrice.value) || Number(editPrice.value) < 0) {
            showEditError(editPrice, "Price must be a valid non-negative number");
            isValid = false;
          } else {
            clearEditError(editPrice);
          }

          // Validate Stock
          if (editStock.value === "" || isNaN(editStock.value) || Number(editStock.value) < 0) {
            showEditError(editStock, "Stock must be a valid non-negative number");
            isValid = false;
          } else {
            clearEditError(editStock);
          }

          if (!isValid) return; // stop if validation fails

          const updatedProduct = {
            name: editName.value.trim(),
            price: Number(editPrice.value),
            stock: Number(editStock.value),
          };

          // only send ageGroup if the field is visible
          if (editAgeGroupWrapper && !editAgeGroupWrapper.classList.contains("d-none")) {
            updatedProduct.ageGroup = editAgeGroup.value;
          }

          try {
            const res = await fetch(`/api/watches/update/${editProductId.value}`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedProduct),
            });

            const data = await res.json();

            if (data.success) {
              editModal.hide(); // modal close will trigger resetEditForm()

              // Refresh only products inside categories
              const updatedCategory = data.product.category; // backend must return category
              const container = document.querySelector(`#${updatedCategory} .row`);

              if (container) {
                fetch(`/api/watches/${updatedCategory}`)
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      container.innerHTML = "";
                      data.products.forEach(product => {
                        const card = document.createElement("div");
                        card.className = "col-md-3 mb-4";
                        card.innerHTML = `
                          <div class="card product-card h-100">
                            <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                              <h5 class="card-title">${product.name}</h5>
                              ${ product.category === "kidsWatches" ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>` : "" }
                              <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                              <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                              <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                                <i class="fas fa-eye"></i> View
                              </button>
                              <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                                <i class="fas fa-edit"></i> Edit
                              </button>
                              <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </div>
                          </div>
                        `;
                        container.appendChild(card);
                      });
                    }
                  })
                  .catch(err => console.error("Error refreshing products:", err));
              }
            } else {
              alert("❌ Failed to update product.");
            }
          } catch (err) {
            console.error("Error updating product:", err);
          }
        });

        // ================== DELETE functionality for Watches ==================
        let deleteWatchId = null;
        const deleteWatchModalEl = document.getElementById("deleteWatchProductModal");
        const deleteWatchModal = new bootstrap.Modal(deleteWatchModalEl);
        const confirmDeleteWatchBtn = document.getElementById("confirmDeleteWatchBtn");

        // Attach to the correct container
        const watchesContainer = document.getElementById("watches-products");

        watchesContainer?.addEventListener("click", (e) => {
          const btn = e.target.closest(".delete-product-btn");
          if (!btn) return;

          deleteWatchId = btn.dataset.id;
          deleteWatchModal.show();
        });

        // Confirm deletion
        confirmDeleteWatchBtn.addEventListener("click", async () => {
          if (!deleteWatchId) return;

          try {
            const res = await fetch(`/api/watches/delete/${deleteWatchId}`, { method: "DELETE" });
            const data = await res.json();

            if (data.success) {
              deleteWatchModal.hide();
              deleteWatchId = null;

              // Refresh all categories
              const categories = ["gentsWatches", "ladiesWatches", "premiumWatches", "kidsWatches"];
              for (const category of categories) {
                const container = document.querySelector(`#${category} .row`);
                if (!container) continue;

                const res = await fetch(`/api/watches/${category}`);
                const data = await res.json();
                if (data.success) {
                  container.innerHTML = "";
                  data.products.forEach(product => {
                    const card = document.createElement("div");
                    card.className = "col-md-3 mb-4";
                    card.innerHTML = `
                      <div class="card product-card h-100">
                        <img src="${product.mainImage}" class="card-img-top" alt="${product.name}">
                        <div class="card-body">
                          <h5 class="card-title">${product.name}</h5>
                          ${ product.category === "kidsWatches" ? `<p class="card-text"><strong>Age Group:</strong> ${product.ageGroup}</p>` : "" }
                          <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                          <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                          <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                            <i class="fas fa-eye"></i> View
                          </button>
                          <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                            <i class="fas fa-edit"></i> Edit
                          </button>
                          <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                            <i class="fas fa-trash"></i> Delete
                          </button>
                        </div>
                      </div>
                    `;
                    container.appendChild(card);
                  });
                }
              }
            } else {
              alert("❌ Failed to delete product.");
            }
          } catch (err) {
            console.error("Error deleting product:", err);
          }
        });
      });
    </script>

    <!-- ========================= LENSES PAGE ======================= -->
    <!-- Products Management - Lenses -->
    <section id="lenses-products" class="content-section">
      <h2>Lenses Products</h2>
      <ul class="nav nav-tabs mb-3" id="lensesTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#powerLens">Power Eye Lens</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#colorLens">Color Lens</button></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane fade show active" id="powerLens">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Power Eye Lens Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBwgHBgkIBwgKCgkLDRYPDQwMDRsUFRAWIB0iIiAdHx8kKDQsJCYxJx8fLT0tMTU3Ojo6Iys/RD84QzQ5OjcBCgoKDQwNGg8PGjclHyU3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3Nzc3N//AABEIAJQA4QMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAEAAIDBQYBB//EADcQAAEEAQMDAgUBBgYDAQAAAAEAAgMRBBIhMQVBURMiBjJhcYEUI0KRocHwB1JisdHxMzSSFf/EABkBAAIDAQAAAAAAAAAAAAAAAAMEAAECBf/EACERAAIDAAMBAAMBAQAAAAAAAAABAgMREiExBCIyQRNR/9oADAMBAAIRAxEAPwD29McbTiUwlQgwjdRzbBSlD5LtkCx9BoLsrc12qmjuaVpis0QgfRVjG+rlNHYFXAFDbwg/Ku3INe+lE447Ia/dv32U8hoISQ39uUw2Diioz2W2RvglZTLGzvutpmtD3Bw4cPcPqsl1GPQ97aQbBqkqQaf+Fsf8O/8A0c0eJv6BYuU6HknYBaf/AAwz4cqPqkUD9RikbfjjssU65hPoxVM0uZ8zlVZB3Vtlj2k91TZB5TExStAkhN7JuRIRivs9kjZKD6zJ6HT5XE/ulAk8TYzGOtGdxj+yvySVyeSmFR479OMyzvVoDqWcI2GtzXASMZadB9Iz/wATSNnmYHkaWHV91SQxNkcXPII8Uj3Ys/Usgk21g4pWuL0RrGtpgPmynYvEc+cXKWkPQsg9LmGQ23RHYtXoGF1zGnYCJRuOCVl4+nRsYGPir8rsvQ4SA5l7/wCVU+y0jYS9SgY3UZGgDvaos/qhznGKC/THfyqY9MMfteZHDtZRWIPSIYSCOyA6+9CRaQbjQ0KrcIxsYpKPToBClFAKzYz00zTuEQBaVDwqZZDpKSm28JLBrT2J2yhc/dSv4Qzhuuw3iOFH0kJ2QeS7Yok/Kgsmy8AJS5vOhitdjunx25zz5Vhahx2aIqUiNXHjHDFktkQzmmoSR2kX2KnnPZV2W+m0Of6KpMJBdFP1DOfDNM5kpbQY5tDmz/f8Vnuq9Vbckvt080RZHZHdWIMrXavbJdA3/D7d1juqerA98U+x9QXXj+7QvfRj9V0cfmT5kBJYTqPA2AHb7rWf4Wj9PnZkbi1vrxgtAFWWneh+VQdPxz+naHBpojSWmgPC0fQceTG6njZYbQaXWfoTVfwW4tLwHOLl6bXL2Y5Uc5V5lua+MuB2O6oMk0VdjM1JgzlQ/E+SHRsxmnndyvX6y0lrbPkLO9R6PJkyGQyGzyD3SlrbjiHaUlLWZvK6h6TfTitzzwAh2Ycs28x/aPFkeAryPo8bZQBGPb/upn4TtdtoWgwjgeT5AOH05kXygI6HBIN6z+UYxntNNpSRivujcgXEAnxpAfI+iiOqKqfp+h7q0I3THwtfRLQfurUisKx8xsiQAoV7Q82zYq4fjBxsRi1BNiuFOAA+gU0rCLElDRTzuOyK1j5gq2ZkrZL0Gh3Ce3IOkCjyqL0tWe7dOQkErT+9aIdLR4pZZY+kkz1UlWFnsR3UTgpAmuXVkujhr0hdwUNWqYBEvHtKgh3mKVmtkkMw8bDBsKTXFdtMemGwS7A8l2xVdOPUiNfMOCjskiigQfmHYpeT7G4LozPUWu1DX8jTufAPlU2fhnLl/anetJcBY3/6WwzMbWDqZe2yr4sQxupoADtnCtvsseBEUnTsRzMZjZBqIIdpaFqMOJscbBq7UoYsdsQvSOKFLmRM2J+GX7NdLoP3I2/mq5FtFozUSABtW9qF0MR12C7fSB4XGTtL9BoEAHn7/wDCFGS1shs7gkCz3JP/AAo5ESJ8nRDE1oG2yBmP7Nre53spnUMlrcYkHcCgeTSDkygDGPpshOQWMTs0bBTfHcd1CWjUS75eya7LaXktAuqATfWv27bIehR8go0z8rhGlpKWoeU4n2KaTCJreL7penQUgGwC4B7tPZXpMI0wubvqBpTOaBajLVaZTQGWBzy4H8FCyYvJB5Vg5gJ8KJ7HAbCwtJmWivYx0ThvsixkajpSEZdy0KB7DG+62+imlBWtJC+oPCSrCz3HUAmlwUJJSDl05HFidkd7SoMf/wAjinPOxUcDg15S7ezQyl+IYCmSLoKZKUV+A0uwDK4KrhJ76OysMk7FVErqJ8pWbxj1S1BXzcpkzG8gUuRuv6p5IcFWkzAR4qyPx9FQ9akOb0+SBjnRZJ1ema+WRvubX/z/ADV7mFob6ZLQ949ourWY61N6bHmZwDXVqdwbHyu+hFUfI8Ie4E46gTpvxEZM1jcpzWzSxN1gn94FwsfQ2B9wQos34g/SZU4e62NLXAd9JFb/AJBWH6zNLJIGxzNjnj9wIOzx2IPnz5ocIBvXphmQy5Ecb5oTwd/VHcEf1RlXyfQJ2qCxm46j1TPn6c+WHEkdEWH32KrygHdXz2tieISfbffceeFRT9WmzIHfp4GwxP39Jri/QPF8fy/ggoMvJxgG+uTE1xAAd/uiKqCAu6xmhf8AEmVAf2uO7T+6QURjfFUbzuyQDyQs87qTpj7qLf8AV4UZZrAe06XdnNHb7LLqgzavmjd43WsaVx0TCx2dsrdkjXtBDtzuvMoJvfpn7/vUrwZGTiFj8eVzmAD2E3sgypzwPG5P02odtzaeDaoem9bZOAJxpJ79lcMkDvlI/CC00GUkyV26Y4LtlIlTTQxw2GyYWEqQlcdur0oY1oChe3YqdMPCsyDaP9I/gkiKCSsh669qjLaRFJjxsupI4cfQV+wKpcrN9DJDQefqrqcARucdmjusn19pY/1AdwlH0xyHhrMOX1WWnz8FUfw3mCZjWl1lXmQaBJRN/Ey1+RWZJoFU+W6j+VctidlymMbXyfAVZ8QYn6GRugkxubYJ890rYnx5fwcqlHlw/pHDLR5U8T7VTFLXKPgfssxehJrB+UxkkRZIAQex8rGdehdCDJC57m92OJ923F+fqtjOGvjIeNTfCxnXnTQOfZMkf+a6I+/lDteeG6l/0866myCeVztM0DgeLFj77bqTpXToX26Ya7dsXkIrqErJtVtJ77stG4TZIseKINZZFhrRRJPFlGqsfABZXHkVubA6SX9PjNe4NG4YEM74ayJunDPhdqa4EuG3saDRc4r2bonwfi9NwGSZdOyHx1MWOIDwdyCvIPifqkUfV8r/APLacaCKVwibE8j6OP53/Ccrqf8ARKy1biKfK6ZkYeS6B7vc3kMO1/3SJ6dFI6TTKNLDz3JRPSIRkYEb3gggkDxQOytcPCORI9sb3Moblrbu0Lns+ITjkORVvgjdIQ0uJa7Tq7OUuVLkY0zTETpAFgjlWmR0t8TmyFopnsjYD28k+VDkYnqaif8AxtFFwHdalFoqMtG4uQyVuoDn5meVb4GdJhvayVxkgPD+7VlsrFdE0PjedJ4o8IvpfUAwCLJ3jf3PZClFMNGTR6FDI2Vgc0ggjkFSE1sqDpc5huIO1R/ulXerUwFLSjg3GWo6d1wLgtJUWK901LukRsoUctJKklelHsJ2UbjZocrj37LkN2XFdZnCI82Bs0QhcSI+XAclAZuPiPj0yRNePqrCeSmlUedMbKVulg9RW5dEOIzFwZw+EOa2923srh2RHkR6onWO/kLMSzHyuY2Z6UgOoj7JSH0NPGOz+VZqNf01gYxzjXvJ/ghPiCEZeDJHXvYNbPwq9nWGtdE1tEVufG5UmRnhxbXfun+UXDDnqE1ZyMs19ko+CSkDlRiLLeG/ITba+qkjfskorHh0ZPVpYucDGd1k/iBwD3b8fzWja620sn8Qn9qed0G1dhKjJugOTmtja0AOIBoLU9NwmO+I8aF7P2QlZzyaQXQMNz8wy6dm7i1Ymf8AT9YjyXEnQ4ONeAiRfFJA5R5abX4j+IsHHORgGVrZ2Rk1wDfg9+y8An6PmZOWWPjMcb3g+o4bUt/8WRmbqsmQ6y14a5rr52QUOqaJrJ2hz2fKT9EWX3STcUKx+KLSbIsbHghxmRRgANaGtFK96X08RREub7juhcDBkyckODfbe2y0rsOWOMAt34Db5W/lraXOZn6JpvjEqMvDErdLht3VZnQiHHdEC0tqmnwtG/FDCDNIQH8BDvjhZZ9NpPY8osrkio0ORm4MTHEBhljNkjTJ+PCqcrpjo3PDWB17BabKFnk/RCta4SAkA7UUF2aMf5Yij6Xkz4EoiyWn0ydiTwtniyNkha5rrCq5sFkgDXAG/opsGF+NbA46PBWZY0XDYluNxsE0gp0Rpu6TiCNuUFoLpEV0G10g900AqiHV1Kl1Qh6zotdPtjATib2HKimcutJ9HFgtYHlP2Ko812xVtkGwVT5nekhczq/OsKqZyFe8g2OUTkIKQ7pFo6SGtyHMeL+W9wrA5JDdFnbhUs13d1RT2TkuYLJcRsmaZasE7449LGR+trT3BpNaSAmRNJ+67JYpo5RGgaYdii2alketl8udoYe/C2mMzRhPcRvSy0kTGZb5pDvft2v/AGQrFskglbxNk+FGzCxHWKdW5QHRQzqHxAMeQ217Hj7Gl2eabNlMAqKLlz3bAf3/ABRvROm4mBN+sa7IfLG2+CAB9b4u/v8A01xcpJrwzyUYtP071DoXUciCPFZEJDjuIa+wLaeAiunfB0jGCXPmvTuWRnYfc/8ACuY8+KCL1NLnSu3BJND8HhQS9RyMmF0c0lNuyB97RmqeW52AUbms/gfjY2JiXC2NrCGmyw8eN+UJmZEb2/s26Q08ACnHyUIch7vUc42TZQvqnTXIPYq5Wtm4UKPY3Llkf8zidPFnsqyWTcgXujX2QaHdR/pw8gmkuMLEiudGXOsJGBxbdC7Vr+maD91IzGH+VaMsrAxxjoi6UsLQW+KR/wCmp10mOhrcUPwppkG1ObZIFfZdjeD/ABUz474H5UQhDTYVPsg7lP0pMb5RAbsskB9KSn0JKiHp45JQ8zuVNKQOEFM/ldGyRzKYAuQ7YqqyHXaOyX8qrnfyufbLTq0xAcndAyA2jJ3IWTdLjiApByfCmhxLx2yNvUDeya9tmlcdPjPoR1wRuEan9gH0fqD4Xpv5tp/1Ix2Pqka5oB7IgY0YNloCnfAz2nEJNEbEUnuMWcvnZGXnRHljTi+mBzyEA7pdxaxYe+gKHH2V26IPkHfZFsiGkbccIf8Al3oZ2YsRSY3SMeKYOdG10zW/ORsB4b/P6p+VjNkIir23bm6av6n8q0kphJJo+UJLLpBAGonhbeYVFvSmlhe4XGPvfdRFrCaHt8hWErS1tAkO7hDPjAA1AElAeDCbBnxl1hoNWmCAn2NGyMEfZlhP9BxZQ2tUTQNsH0UrMdp2IRQio7b13Tw1QrQP9OA7hStjaBwiQwDlNIUIDGK72pRPjHFIp26YW2VRAR0W3CjMI7hHlmyYWKFgQipTtjUpYnBqohDoSU9BJQo28pQM55RcppV+U/Ypmx9CtSK/Jfyq6U2EVO/coKV2y58/TqQWIFlQz7vlTyuQ53QwyGVZ5paLpzWjHirc6AVnwLK1nT4j+miJArSNymfm7bFvqaUUcbEXuGrYFEwMAHylS+1vusWE1nupo2PJ+qdXRzW9JGR0VPVNSjYAEnu2paZhA04HJFhBSNv5fajHndRkbIbWhYvCtfE4miAFH+m1GyCrItodlz07/wC6Q+IXmAthAOw3HAK6GEbu3Rnp1/2uFqnEnMF0FLQp9I8ppF7d1TRaZEW0FHSIMZPYLgiIPCpotMGMaWikWWUoCCXfRZaNJkRCbpUzmWmFtLJZEQknlNIUINSTqC6oQ1ztwbQGUBukkmrfBWn0qcgCyq2c0SkkkJnUh4ByJg5SSQwiF3Wwx4WDHjO/yja/okkmfm9Yr9fiJWgb/ThPjN5JvsEkk2hFhQ4UMiSS2wcQZ/KjLjaSSGwqE76pwFhcSUXpGLh1JOASSUIhpAATOSkkss0joAScEklRoY9RUEkkNm0NKickkqNDKTSkkslnEkklRD//2Q==" class="card-img-top" alt="SharpSight Daily Disposables">
                    <div class="card-body">
                      <h5 class="card-title">SharpSight Daily Disposables</h5>
                      <p class="card-text"><strong>ID:</strong> PL001</p>
                      <p class="card-text"><strong>Power Range:</strong> -1.00 to -6.00</p>
                      <p class="card-text"><strong>Price:</strong> $30.00</p>
                      <p class="card-text"><strong>Stock:</strong> 150</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="colorLens">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Color Lens Products
              <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Product</button>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- Product 1 -->
                <div class="col-md-3 mb-4">
                  <div class="card product-card h-100">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS_-IvYX28s1__H69nNr-JbdEWu2bYtDYSV93aEuOOrJE9rlEFExv9vYLsz4VEifrL_cts&usqp=CAU" class="card-img-top" alt="Hazel Glow">
                    <div class="card-body">
                      <h5 class="card-title">Hazel Glow</h5>
                      <p class="card-text"><strong>ID:</strong> CL001</p>
                      <p class="card-text"><strong>Color:</strong> Hazel</p>
                      <p class="card-text"><strong>Price:</strong> $25.00</p>
                      <p class="card-text"><strong>Stock:</strong> 120</p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                      <button class="btn btn-warning btn-sm"><i class="fas fa-eye"></i> View</button>
                      <button class="btn btn-info btn-sm"><i class="fas fa-edit"></i> Edit</button>
                      <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Add Lens Product Modal -->
    <div class="modal fade" id="addLensModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form id="addLensForm" class="needs-validation" enctype="multipart/form-data" novalidate autocomplete="off">
          <div class="modal-content">
            <div class="modal-header text-white bg-primary">
              <h5 class="modal-title">Add Lens Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <!-- Hidden Category (PowerLenses / ColoredLenses) -->
              <input type="hidden" name="category" id="lensCategory">

              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" name="name" class="form-control" required>
                <div class="invalid-feedback">Product name is required.</div>
              </div>

              <!-- Brand -->
              <div class="mb-3">
                <label class="form-label">Brand</label>
                <input type="text" name="brand" class="form-control" required>
                <div class="invalid-feedback">Brand name is required.</div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3"></textarea>
              </div>

              <!-- Price -->
              <div class="mb-3">
                <label class="form-label">Price</label>
                <input type="number" name="price" class="form-control" min="1" step="any" required>
                <div class="invalid-feedback">Price is required and must be greater than zero.</div>
              </div>

              <!-- Stock -->
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input type="number" name="stock" class="form-control" min="1" step="1" required>
                <div class="invalid-feedback">Stock is required and must be greater than zero.</div>
              </div>

              <!-- Color -->
              <div class="mb-3" id="colorWrapper">
                <label class="form-label">Color</label>
                <input type="text" name="color" class="form-control" placeholder="e.g., Blue, Green, Hazel">
                <div class="form-text text-primary">Leave blank for clear lenses.</div>
              </div>

              <!-- Power Fields (for Power Lenses only) -->
              <div id="powerFields" class="d-none">

                <div class="mb-3">
                  <label class="form-label">Lens Type</label>
                  <select name="lensType" class="form-control">
                    <option value="Single Vision">Single Vision</option>
                  </select>
                </div>
              </div>

              <!-- Main Image -->
              <div class="mb-3">
                <label class="form-label">Main Image</label>
                <input type="file" name="mainImage" class="form-control" accept="image/*" required>
                <div class="invalid-feedback">Main product image is required.</div>
              </div>

              <!-- Sub Images -->
              <div class="mb-3">
                <label class="form-label">Sub Images (up to 3)</label>
                <input type="file" name="subImages" class="form-control" accept="image/*" multiple>
              </div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save Product</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    <!-- Lenses Confirmation Modal -->
    <div class="modal fade" id="lensesConfirmationModal" tabindex="-1">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content rounded-2" style="width: 350px; height: 200px; margin: auto;">
          <div class="modal-body d-flex flex-column justify-content-center align-items-center text-center">
            <p id="lensesConfirmationMessage" class="fs-4"></p>
          </div>
        </div>
      </div>
    </div>
    <!-- View Lens Modal -->
    <div class="modal fade" id="viewLensModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Product Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewLensModalBody">
            <!-- Lens details will be dynamically injected here -->
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Lens Product Modal -->
    <div class="modal fade" id="editLensProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info">
            <h5 class="modal-title">Edit Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editLensForm" autocomplete="off" novalidate>
              <input type="hidden" id="editLensProductId" name="productId">

              <div class="mb-3">
                <label for="editLensName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="editLensName" name="name" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editLensPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="editLensPrice" name="price" min="1" autocomplete="off" required>
              </div>

              <div class="mb-3">
                <label for="editLensStock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="editLensStock" name="stock" min="1" autocomplete="off" required>
              </div>

            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" form="editLensForm" class="btn btn-info">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Delete Lens Modal -->
    <div class="modal fade" id="deleteLensProductModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this Product?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteLensBtn" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Lenses Product JS -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ================ Add Lens Modal (Add + validation) =================
        const addButtons = document.querySelectorAll("#lenses-products .btn-primary");
        const categoryInput = document.getElementById("lensCategory");
        const addProductForm = document.getElementById("addLensForm");
        const powerFieldsWrapper = document.getElementById("powerFields");
        const addProductModalEl = document.getElementById("addLensModal");

        // Map tabPane id -> category value used by backend/schema
        const tabToCategory = {
          powerLens: "PowerLenses",
          colorLens: "ColoredLenses"
        };

        addButtons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            // Reset form before opening
            addProductForm.reset();
            // clear any old inline errors
            addProductForm.querySelectorAll(".error-message").forEach(el => el.remove());

            const tabPane = e.target.closest(".tab-pane");
            if (!tabPane) return;
            const tabId = tabPane.getAttribute("id");
            const category = tabToCategory[tabId] || tabId;

            categoryInput.value = category;

            // Show/hide power fields for PowerLenses
            if (category === "PowerLenses") {
              powerFieldsWrapper.classList.remove("d-none");
            } else {
              powerFieldsWrapper.classList.add("d-none");
            }

            new bootstrap.Modal(document.getElementById("addLensModal")).show();
          });
        });

        // Reset when modal closed
        if (addProductModalEl) {
          addProductModalEl.addEventListener("hidden.bs.modal", () => {
            addProductForm.reset();
            categoryInput.value = "";
            if (powerFieldsWrapper) powerFieldsWrapper.classList.add("d-none");
            addProductForm.querySelectorAll(".error-message").forEach(el => el.remove());
          });
        }

        // Add form submit
        addProductForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          let valid = true;
          addProductForm.querySelectorAll(".error-message").forEach(el => el.remove());

          const name = addProductForm.querySelector("[name='name']");
          const brand = addProductForm.querySelector("[name='brand']");
          const price = addProductForm.querySelector("[name='price']");
          const stock = addProductForm.querySelector("[name='stock']");
          const mainImage = addProductForm.querySelector("[name='mainImage']");

          // name
          if (!name.value.trim()) {
            showError(name, "Product name is required");
            valid = false;
          }

          // brand
          if (!brand.value.trim()) {
            showError(brand, "Brand is required");
            valid = false;
          }

          // price
          if (!price.value || Number(price.value) <= 0) {
            showError(price, "Price is required and must be greater than zero.");
            valid = false;
          }

          // stock
          if (!stock.value || Number(stock.value) <= 0) {
            showError(stock, "Stock is required and must be greater than zero.");
            valid = false;
          }

          // main image
          if (!mainImage.files || mainImage.files.length === 0) {
            showError(mainImage, "Main image is required");
            valid = false;
          }


          if (!valid) return;

          const formData = new FormData(addProductForm);

          try {
            const res = await fetch("/api/lenses/add", {
              method: "POST",
              body: formData
            });
            const data = await res.json();

            // close add modal
            const addModalInstance = bootstrap.Modal.getInstance(document.getElementById("addLensModal"));
            if (addModalInstance) addModalInstance.hide();

            // show confirmation modal
            const confirmationMessage = document.getElementById("lensesConfirmationMessage");
            const confirmationModalEl = document.getElementById("lensesConfirmationModal");
            const confirmationModal = new bootstrap.Modal(confirmationModalEl);

            if (data.success) {
              confirmationMessage.innerHTML = `<i class="fas fa-check-circle text-primary"></i> Product added successfully!`;
              confirmationModal.show();
              setTimeout(() => location.reload(), 3000);
            } else {
              confirmationMessage.innerText = "❌ Error adding product.";
              confirmationModal.show();
            }
          } catch (err) {
            console.error("Error adding lens:", err);
            const confirmationMessage = document.getElementById("lensesConfirmationMessage");
            const confirmationModalEl = document.getElementById("lensesConfirmationModal");
            const confirmationModal = new bootstrap.Modal(confirmationModalEl);
            confirmationMessage.innerText = "❌ Error adding product.";
            confirmationModal.show();
          }
        });

        // helper to show inline errors
        function showError(input, message) {
          if (!input || !input.parentNode) return;
          if (input.parentNode.querySelector(".error-message")) return;
          const error = document.createElement("div");
          error.className = "error-message text-danger small mt-1";
          error.innerText = message;
          input.parentNode.appendChild(error);

          function clearError() {
            const existing = input.parentNode.querySelector(".error-message");
            if (existing) existing.remove();
            input.removeEventListener("focus", clearError);
            input.removeEventListener("input", clearError);
          }
          input.addEventListener("focus", clearError);
          input.addEventListener("input", clearError);
        }

        // Show/hide powerFields when user manually switches tab (optional)
        // (If user switches tabs without opening add modal)
        const lensesTabs = document.getElementById("lensesTabs");
        if (lensesTabs) {
          lensesTabs.addEventListener("shown.bs.tab", (e) => {
            const target = e.target.getAttribute("data-bs-target"); // like #powerLens
            const id = target?.replace("#", "");
            const cat = tabToCategory[id];
            if (cat === "PowerLenses") {
              // nothing to do here unless form open; this keeps behaviour consistent
            } else {
              // nothing
            }
          });
        }
      });

      // ================== Fetch / View / Edit / Delete lenses (dashboard) ==================
      document.addEventListener("DOMContentLoaded", () => {
        // categories to fetch from backend (match schema values)
        const categories = ["PowerLenses", "ColoredLenses"];
        // map backend category -> tab-pane id in DOM
        const catToTabId = {
          PowerLenses: "powerLens",
          ColoredLenses: "colorLens"
        };

        categories.forEach(category => {
          fetch(`/api/lenses/${category}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const tabId = catToTabId[category];
                const container = document.querySelector(`#${tabId} .row`);
                if (!container) return;
                container.innerHTML = "";
                data.products.forEach(product => {
                  const card = document.createElement("div");
                  card.className = "col-md-3 mb-4";
                  card.innerHTML = `
                    <div class="card product-card h-100">
                      <img src="${product.mainImage}" class="card-img-top" alt="${escapeHtml(product.name)}">
                      <div class="card-body">
                        <h5 class="card-title">${escapeHtml(product.name)}</h5>
                        ${ product.category === "PowerLenses" ? `<p class="card-text"><strong>Brand:</strong> ${escapeHtml(product.brand)}</p>` : `<p class="card-text"><strong>Color:</strong> ${escapeHtml(product.color || 'Clear')}</p>` }
                        <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                        <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                      </div>
                      <div class="card-footer d-flex justify-content-between">
                        <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                          <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                          <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                          <i class="fas fa-trash"></i> Delete
                        </button>
                      </div>
                    </div>
                  `;
                  container.appendChild(card);
                });
              }
            })
            .catch(err => console.error(`Error fetching category ${category}:`, err));
        });

        // Helper: simple escape to avoid breaking HTML when injecting strings
        function escapeHtml(str) {
          if (!str && str !== 0) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        // ================= View product details =================
        document.addEventListener("click", (e) => {
          const btn = e.target.closest(".view-product-btn");
          if (!btn) return;
          const productId = btn.dataset.id;
          fetch(`/api/lenses/product/${productId}`)
            .then(res => res.json())
            .then(resp => {
              if (!resp || !resp.success) return;
              const p = resp.product;

              const modalBody = document.getElementById("viewLensModalBody");
              if (!modalBody) return;

              modalBody.innerHTML = `
                <div class="row">
                  <div class="col-md-5 text-center">
                    <img src="${p.mainImage}" class="img-fluid rounded mb-3" alt="${escapeHtml(p.name)}">
                    <div class="d-flex gap-2 flex-wrap justify-content-center">
                      ${
                        p.subImages && p.subImages.length
                          ? p.subImages.map(img => `<img src="${img}" class="img-thumbnail" style="width:80px; height:80px;">`).join("")
                          : ""
                      }
                    </div>
                  </div>
                  <div class="col-md-7">
                    <h4>${escapeHtml(p.name)}</h4>
                    <p>${escapeHtml(p.description || "No description available.")}</p>
                    <p><strong>Brand:</strong> ${escapeHtml(p.brand || 'N/A')}</p>
                    <p><strong>Color:</strong> ${escapeHtml(p.color || 'Clear')}</p>
                    <p><strong>Price:</strong> Rs. ${p.price}</p>
                    <p><strong>Stock:</strong> ${p.stock}</p>
                    ${
                      p.category === "PowerLenses"
                        ? `
                          <p><strong>Lens Type:</strong> ${escapeHtml(p.lensType || 'Single Vision')}</p>`
                          : ""
                    }
                  </div>
                </div>
              `;

              new bootstrap.Modal(document.getElementById("viewLensModal")).show();
            })
            .catch(err => console.error("Error fetching lens details:", err));
        });

        // ================== Edit product ==================
        const editModalEl = document.getElementById("editLensProductModal");
        const editModal = new bootstrap.Modal(editModalEl);
        const editForm = document.getElementById("editLensForm");
        const editProductId = document.getElementById("editLensProductId");
        const editName = document.getElementById("editLensName");
        const editPrice = document.getElementById("editLensPrice");
        const editStock = document.getElementById("editLensStock");

        // helper edit error handling
        function showEditError(inputEl, message) {
          if (!inputEl || !inputEl.parentElement) return;
          let errorEl = inputEl.parentElement.querySelector(".error-text");
          if (!errorEl) {
            errorEl = document.createElement("div");
            errorEl.className = "error-text text-danger mt-1";
            inputEl.parentElement.appendChild(errorEl);
          }
          errorEl.textContent = message;
        }
        function clearEditError(inputEl) {
          if (!inputEl || !inputEl.parentElement) return;
          const errorEl = inputEl.parentElement.querySelector(".error-text");
          if (errorEl) errorEl.textContent = "";
        }

        function resetEditForm() {
          if (!editForm) return;
          editForm.reset();
          [editName, editPrice, editStock].forEach(clearEditError);
          editProductId.value = "";
        }

        [editName, editPrice, editStock].forEach(input => {
          if (!input) return;
          input.addEventListener("focus", () => clearEditError(input));
          input.addEventListener("input", () => clearEditError(input));
        });

        if (editModalEl) editModalEl.addEventListener("hidden.bs.modal", resetEditForm);

        // open edit modal when edit button clicked
        document.addEventListener("click", async (e) => {
          const btn = e.target.closest(".edit-product-btn");
          if (!btn) return;
          const productId = btn.dataset.id;
          try {
            const res = await fetch(`/api/lenses/product/${productId}`);
            const data = await res.json();
            if (data.success) {
              const p = data.product;
              editProductId.value = p._id;
              editName.value = p.name || "";
              editPrice.value = p.price ?? "";
              editStock.value = p.stock ?? "";
              editModal.show();
            }
          } catch (err) {
            console.error("Error fetching lens for edit:", err);
          }
        });

        // handle edit save
        if (editForm) {
          editForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            let isValid = true;

            if (!editName.value.trim()) {
              showEditError(editName, "Name is required");
              isValid = false;
            } else {
              clearEditError(editName);
            }

            if (editPrice.value === "" || isNaN(editPrice.value) || Number(editPrice.value) < 0) {
              showEditError(editPrice, "Price must be a valid non-negative number");
              isValid = false;
            } else {
              clearEditError(editPrice);
            }

            if (editStock.value === "" || isNaN(editStock.value) || Number(editStock.value) < 0) {
              showEditError(editStock, "Stock must be a valid non-negative number");
              isValid = false;
            } else {
              clearEditError(editStock);
            }

            if (!isValid) return;

            const updatedProduct = {
              name: editName.value.trim(),
              price: Number(editPrice.value),
              stock: Number(editStock.value)
            };

            try {
              const res = await fetch(`/api/lenses/update/${editProductId.value}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedProduct)
              });
              const data = await res.json();
              if (data.success) {
                editModal.hide();

                // refresh only the updated category tab
                const updatedCategory = data.product.category; // "PowerLenses" or "ColoredLenses"
                const tabId = catToTabId[updatedCategory];
                const container = document.querySelector(`#${tabId} .row`);
                if (container) {
                  const resp = await fetch(`/api/lenses/${updatedCategory}`);
                  const d = await resp.json();
                  if (d.success) {
                    container.innerHTML = "";
                    d.products.forEach(product => {
                      const card = document.createElement("div");
                      card.className = "col-md-3 mb-4";
                      card.innerHTML = `
                        <div class="card product-card h-100">
                          <img src="${product.mainImage}" class="card-img-top" alt="${escapeHtml(product.name)}">
                          <div class="card-body">
                            <h5 class="card-title">${escapeHtml(product.name)}</h5>
                            ${ product.category === "PowerLenses" ? `<p class="card-text"><strong>Brand:</strong> ${escapeHtml(product.brand)}</p>` : `<p class="card-text"><strong>Color:</strong> ${escapeHtml(product.color || 'Clear')}</p>` }
                            <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                            <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                          </div>
                          <div class="card-footer d-flex justify-content-between">
                            <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                              <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                              <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                              <i class="fas fa-trash"></i> Delete
                            </button>
                          </div>
                        </div>
                      `;
                      container.appendChild(card);
                    });
                  }
                }
              } else {
                alert("❌ Failed to update product.");
              }
            } catch (err) {
              console.error("Error updating lens:", err);
            }
          });
        }

        // ================== DELETE functionality for Lenses ==================
        let deleteLensId = null;
        const deleteLensModalEl = document.getElementById("deleteLensProductModal");
        const deleteLensModal = new bootstrap.Modal(deleteLensModalEl);
        const confirmDeleteLensBtn = document.getElementById("confirmDeleteLensBtn");
        const lensesContainer = document.getElementById("lenses-products");

        lensesContainer?.addEventListener("click", (e) => {
          const btn = e.target.closest(".delete-product-btn");
          if (!btn) return;
          deleteLensId = btn.dataset.id;
          deleteLensModal.show();
        });

        confirmDeleteLensBtn?.addEventListener("click", async () => {
          if (!deleteLensId) return;
          try {
            const res = await fetch(`/api/lenses/delete/${deleteLensId}`, { method: "DELETE" });
            const data = await res.json();
            if (data.success) {
              deleteLensModal.hide();
              deleteLensId = null;

              // Refresh both categories tabs
              const categories = ["PowerLenses", "ColoredLenses"];
              for (const category of categories) {
                const tabId = catToTabId[category];
                const container = document.querySelector(`#${tabId} .row`);
                if (!container) continue;
                try {
                  const resp = await fetch(`/api/lenses/${category}`);
                  const d = await resp.json();
                  if (d.success) {
                    container.innerHTML = "";
                    d.products.forEach(product => {
                      const card = document.createElement("div");
                      card.className = "col-md-3 mb-4";
                      card.innerHTML = `
                        <div class="card product-card h-100">
                          <img src="${product.mainImage}" class="card-img-top" alt="${escapeHtml(product.name)}">
                          <div class="card-body">
                            <h5 class="card-title">${escapeHtml(product.name)}</h5>
                            ${ product.category === "PowerLenses" ? `<p class="card-text"><strong>Brand:</strong> ${escapeHtml(product.brand)}</p>` : `<p class="card-text"><strong>Color:</strong> ${escapeHtml(product.color || 'Clear')}</p>` }
                            <p class="card-text"><strong>Price:</strong> Rs. ${product.price}</p>
                            <p class="card-text"><strong>Stock:</strong> ${product.stock}</p>
                          </div>
                          <div class="card-footer d-flex justify-content-between">
                            <button class="btn btn-warning btn-sm view-product-btn" data-id="${product._id}">
                              <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-info btn-sm edit-product-btn" data-id="${product._id}">
                              <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm delete-product-btn" data-id="${product._id}">
                              <i class="fas fa-trash"></i> Delete
                            </button>
                          </div>
                        </div>
                      `;
                      container.appendChild(card);
                    });
                  }
                } catch (err) {
                  console.error("Error refreshing category", category, err);
                }
              }
            } else {
              alert("❌ Failed to delete product.");
            }
          } catch (err) {
            console.error("Error deleting lens:", err);
          }
        });

      });
    </script>


    <!-- Orders Management -->
    <section id="orders-management" class="content-section">
      <h2 class="mb-4">Orders Management</h2>

      <!-- Pending Orders -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Pending Orders</span>
          <small id="pendingCount">1 Pending</small>
        </div>
        <div class="card-body">
          <table class="table table-hover align-middle text-center">
            <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Customer Name</th>
                <th>Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingOrdersTable">
              <tr>
                <td>#001</td>
                <td>John Doe</td>
                <td>2025-10-14</td>
                <td>Rs. 3,500</td>
                <td><span class="badge border border-warning text-warning">Pending</span></td>
                <td>
                  <div class="btn-group me-2" role="group" aria-label="View and Delete">
                    <button class="btn btn-warning btn-sm me-1">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                  <div class="btn-group" role="group" aria-label="Accept and Reject">
                    <button class="btn btn-success btn-sm px-3 me-1">
                      Accept
                    </button>
                    <button class="btn btn-info btn-sm px-3">
                      Reject
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Accepted Orders -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Accepted Orders</span>
          <small id="acceptedCount">1 Accepted</small>
        </div>
        <div class="card-body">
          <table class="table table-hover align-middle text-center">
            <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Customer Name</th>
                <th>Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="acceptedOrdersTable">
              <tr>
                <td>#010</td>
                <td>Alice Johnson</td>
                <td>2025-10-10</td>
                <td>Rs. 2,800</td>
                <td><span class="badge border border-success text-success">Accepted</span></td>
                <td>
                  <div class="btn-group me-2" role="group" aria-label="View and Delete">
                    <button class="btn btn-warning btn-sm me-1">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                  <button class="btn btn-info btn-sm complete-btn">
                    <i class="fas fa-truck"></i> Complete
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Rejected Orders -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Rejected Orders</span>
          <small id="rejectedCount">1 Rejected</small>
        </div>
        <div class="card-body">
          <table class="table table-hover align-middle text-center">
            <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Customer Name</th>
                <th>Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rejectedOrdersTable">
              <tr>
                <td>#015</td>
                <td>Michael Brown</td>
                <td>2025-10-09</td>
                <td>Rs. 1,200</td>
                <td><span class="badge border border-primary text-primary">Rejected</span></td>
                <td>
                  <div class="btn-group me-2" role="group" aria-label="View and Delete">
                    <button class="btn btn-warning btn-sm me-1">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-danger btn-sm">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- View Order Modal -->
    <div class="modal fade" id="viewOrderModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">Order Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewOrderModalBody">
            <!-- Details will be injected dynamically -->
          </div>
        </div>
      </div>
    </div>
    <!-- Delete Order Modal -->
    <div class="modal fade" id="deleteOrderModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this Order?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteOrderBtn" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div> 
    <!-- Orders Management JS-->
    <script>
      document.addEventListener("DOMContentLoaded", fetchOrders);

      async function fetchOrders() {
        try {
          const res = await fetch("/api/orders");
          const orders = await res.json();
          console.log("Fetched orders:", orders);

          if (!Array.isArray(orders) || orders.length === 0) return;

          const pendingTable = document.getElementById("pendingOrdersTable");
          const acceptedTable = document.getElementById("acceptedOrdersTable");
          const rejectedTable = document.getElementById("rejectedOrdersTable");

          pendingTable.innerHTML = "";
          acceptedTable.innerHTML = "";
          rejectedTable.innerHTML = "";

          const pendingOrders = orders.filter(o => o.orderStatus === "pending");
          const acceptedOrders = orders.filter(o => o.orderStatus === "accepted");
          const rejectedOrders = orders.filter(o => o.orderStatus === "rejected");

          const renderOrders = (orderList, table, status) => {
            orderList.forEach((order, index) => {
              const orderNumber = `${String(index + 1).padStart(2, "0")}`;
              const customer = order.deliveryAddress?.fullname || "Unknown";
              const date = new Date(order.orderDate).toLocaleDateString();

              const total = "Rs. " + Number(order.totalAmount).toLocaleString("en-PK", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              });

              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${orderNumber}</td>
                <td>${customer}</td>
                <td>${date}</td>
                <td>${total}</td>
                <td>
                  <span class="badge border ${
                    status === "pending"
                      ? "border-warning text-warning"
                      : status === "accepted"
                      ? "border-success text-success"
                      : "border-primary text-primary"
                  }">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                </td>
                <td>
                  <div class="btn-group me-2">
                    <button class="btn btn-warning btn-sm me-1 view-btn" data-id="${order._id}">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <button class="btn btn-danger btn-sm delete-order-btn" data-id="${order._id}">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                  ${
                    status === "pending"
                      ? `
                        <div class="btn-group">
                          <button class="btn btn-success btn-sm px-3 me-1 accept-btn" data-id="${order._id}">Accept</button>
                          <button class="btn btn-info btn-sm px-3 reject-btn" data-id="${order._id}">Reject</button>
                        </div>
                      `
                      : status === "accepted"
                        ? order.isDispatched
                          ? `<button class="btn btn-success btn-sm"><i class="fas fa-check-circle"></i> Dispatched</button>`
                          : `<button class="btn btn-info btn-sm complete-btn" data-id="${order._id}"><i class="fas fa-truck"></i> Complete</button>`
                        : ""
                  }
                </td>
              `;
              table.appendChild(row);
            });
          };

          renderOrders(pendingOrders, pendingTable, "pending");
          renderOrders(acceptedOrders, acceptedTable, "accepted");
          renderOrders(rejectedOrders, rejectedTable, "rejected");

          document.getElementById("pendingCount").textContent = `${pendingOrders.length} Pending`;
          document.getElementById("acceptedCount").textContent = `${acceptedOrders.length} Accepted`;
          document.getElementById("rejectedCount").textContent = `${rejectedOrders.length} Rejected`;

        } catch (err) {
          console.error("Error fetching orders:", err);
        }
      }

      //  View button handler → show modal
      document.addEventListener("click", async function (e) {
        const btn = e.target.closest(".view-btn");
        if (btn) {
          const orderId = btn.dataset.id;
          try {
            const res = await fetch(`/api/orders/${orderId}`);
            const order = await res.json();

            if (!order) return;

            const productsHTML = order.items.map(item => `
              <tr>
                <td>${item.name}</td>
                <td>${item.category || "-"}</td>
                <td>${item.qty}</td>
                <td>${item.ageGroup || "-"}</td>
                <td>${item.brand || "-"}</td>
                <td>${item.color || "-"}</td>
                <td>${item.power?.right || "-"} / ${item.power?.left || "-"}</td>
                <td>Rs. ${Number(item.price).toLocaleString("en-PK")}</td>
              </tr>
            `).join("");

            const modalHTML = `
              <h5 class="mb-3 fw-bold" style="color: #b8860b;">Product Information</h5>
              <table class="table table-bordered text-center">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Qty</th>
                    <th>Age Group</th>
                    <th>Brand</th>
                    <th>Color</th>
                    <th>Power (R/L)</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>${productsHTML}</tbody>
              </table>

              <hr>
              <h5 class="mb-3 fw-bold" style="color: #b8860b;">Customer Information</h5>
              <p><strong>Name:</strong> ${order.deliveryAddress?.fullname || "N/A"}</p>
              <p><strong>Phone:</strong> ${order.deliveryAddress?.phone || "N/A"}</p>
              <p><strong>Address:</strong> ${order.deliveryAddress?.addressLine || "N/A"}, 
                ${order.deliveryAddress?.city || ""}, ${order.deliveryAddress?.state || ""}, ${order.deliveryAddress?.postal || ""}</p>

              <hr>
              <h5 class="mb-3 fw-bold" style="color: #b8860b;">Order Summary</h5>
              <p><strong>Order ID:</strong> ${order._id}</p>
              <p><strong>Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
              <p><strong>Status:</strong> ${order.orderStatus}</p>
              <p><strong>Payment:</strong> ${order.paymentMethod}</p>
              <p><strong>Total Amount:</strong> Rs. ${Number(order.totalAmount).toLocaleString("en-PK", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
              })}</p>
            `;

            document.getElementById("viewOrderModalBody").innerHTML = modalHTML;
            const modal = new bootstrap.Modal(document.getElementById("viewOrderModal"));
            modal.show();
          } catch (error) {
            console.error("Error loading order details:", error);
          }
        }
      });

      // Delete button handler
      let orderIdToDelete = null;

      // Open delete modal and store ID
      document.addEventListener("click", function (e) {
        const btn = e.target.closest(".delete-order-btn");
        if (!btn) return;

        orderIdToDelete = btn.dataset.id;
        const deleteModal = new bootstrap.Modal(document.getElementById("deleteOrderModal"));
        deleteModal.show();
      });

      // Delete order
      document.getElementById("confirmDeleteOrderBtn").addEventListener("click", async function () {
        if (!orderIdToDelete) return;

        try {
          const res = await fetch(`/api/orders/${orderIdToDelete}`, { method: "DELETE" });

          if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById("deleteOrderModal")).hide();
            await fetchOrders();
            orderIdToDelete = null;
          } else {
            console.error("Failed to delete order");
          }
        } catch (err) {
          console.error("Error deleting order:", err);
        }
      });

      // Accept button handler → check stock then accept
      let orderToAccept = null;

      // Step 1: Show confirmation modal when "Accept" clicked
      document.addEventListener("click", function (e) {
        const btn = e.target.closest(".accept-btn");
        if (!btn) return;

        orderToAccept = btn.dataset.id;

        // Show first confirm modal (already exists in HTML or create dynamically)
        const modalHTML = `
          <div class="modal fade" id="acceptConfirmModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">Confirm Accept</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Are you sure you want to accept this order?</div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" id="acceptConfirmOkBtn" class="btn btn-success">Accept</button>
                </div>
              </div>
            </div>
          </div>
        `;
        // Remove old modal if exists
        const existing = document.getElementById("acceptConfirmModal");
        if (existing) existing.remove();
        document.body.insertAdjacentHTML("beforeend", modalHTML);

        const modalEl = document.getElementById("acceptConfirmModal");
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // Step 2: Handle OK click
        document.getElementById("acceptConfirmOkBtn").addEventListener("click", async function () {
          modal.hide(); // hide first confirmation modal

          try {
            // Call backend route to accept order (check stock)
            const res = await fetch(`/api/orders/${orderToAccept}/accept`, { method: "PUT" });
            const data = await res.json();

            // Show result modal
            const resultModalHTML = `
              <div class="modal fade" id="acceptResultModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header ${res.ok ? "bg-success" : "bg-danger"} text-white">
                      <h5 class="modal-title">${res.ok ? "Success" : "Error"}</h5>
                    </div>
                    <div class="modal-body text-center" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                      ${res.ok ? "Order accepted successfully!" : data.message || "Insufficient stock!"}
                    </div>
                  </div>
                </div>
              </div>
            `;

            const oldModal = document.getElementById("acceptResultModal");
            if (oldModal) oldModal.remove();
            document.body.insertAdjacentHTML("beforeend", resultModalHTML);

            const resultModalEl = document.getElementById("acceptResultModal");
            const resultModal = new bootstrap.Modal(resultModalEl);
            resultModal.show();

            // Auto-close after 2.5 seconds
            setTimeout(() => {
              resultModal.hide();
            }, 2500);

            if (res.ok) {
              await fetchOrders(); // refresh tables if accepted
            }

            orderToAccept = null;
          } catch (err) {
            console.error("Error accepting order:", err);
            alert("Something went wrong!"); // fallback
          }
        });
      });

      // Reject button handler
      let orderToReject = null;

      document.addEventListener("click", function (e) {
        const btn = e.target.closest(".reject-btn");
        if (!btn) return;

        orderToReject = btn.dataset.id;

        // Create Reject Confirmation Modal
        const modalHTML = `
          <div class="modal fade" id="rejectConfirmModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-info text-white">
                  <h5 class="modal-title">Confirm Reject</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Are you sure you want to reject this order?</div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" id="rejectConfirmOkBtn" class="btn btn-info">Reject</button>
                </div>
              </div>
            </div>
          </div>
        `;

        // Remove old modal if exists
        const existing = document.getElementById("rejectConfirmModal");
        if (existing) existing.remove();

        document.body.insertAdjacentHTML("beforeend", modalHTML);
        const modalEl = document.getElementById("rejectConfirmModal");
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        // Handle Confirm Reject
        document.getElementById("rejectConfirmOkBtn").addEventListener("click", async function () {
          modal.hide(); // hide confirmation modal

          try {
            // Call backend route to reject the order
            const res = await fetch(`/api/orders/${orderToReject}/reject`, { method: "PUT" });
            const data = await res.json();

            // show result modal
            const resultModalHTML = `
              <div class="modal fade" id="rejectResultModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header ${res.ok ? "bg-info" : "bg-danger"} text-white">
                      <h5 class="modal-title">${res.ok ? "Success" : "Error"}</h5>
                    </div>
                    <div class="modal-body text-center" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                      ${res.ok ? "Order rejected successfully!" : data.message || "Failed to reject order!"}
                    </div>
                  </div>
                </div>
              </div>
            `;
            const oldModal = document.getElementById("rejectResultModal");
            if (oldModal) oldModal.remove();
            document.body.insertAdjacentHTML("beforeend", resultModalHTML);
            const resultModalEl = document.getElementById("rejectResultModal");
            const resultModal = new bootstrap.Modal(resultModalEl);
            resultModal.show();

            setTimeout(() => resultModal.hide(), 2500);

            if (res.ok) {
              await fetchOrders(); // refresh tables to move order to Rejected
            }

            orderToReject = null;
          } catch (err) {
            console.error("Error rejecting order:", err);
            alert("Something went wrong!");
          }
        });
      });

      // Complete button handler
      document.addEventListener("click", async function (e) {
        const btn = e.target.closest(".complete-btn");
        if (!btn) return;

        const orderId = btn.dataset.id;

        try {
          const res = await fetch(`/api/orders/${orderId}/dispatch`, { method: "PUT" });
          const data = await res.json();

          if (res.ok) {
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Dispatched';
            btn.classList.remove("btn-info");
            btn.classList.add("btn-success");
            // btn.disabled = true;
          } else {
            alert(data.message || "Failed to dispatch order");
          }
        } catch (err) {
          console.error(err);
          alert("Something went wrong!");
        }
      });
    </script>

    <!-- ========================= REVIEWS PAGE ======================= -->
    <!-- Reviews Management -->
    <section id="reviews-management" class="content-section">
      <h2>Reviews Management</h2>
      <div class="card">
        <div class="card-header">Customer Reviews</div>
        <div class="card-body">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Product</th>
                <th>Rating</th>
                <th>Comment</th>
                <th>Date</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="reviewsTableBody">
              <!-- rows will be inserted here dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Delete Modal -->
      <div class="modal fade" id="reviewDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this review?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmReviewDeleteBtn">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- View Review Modal -->
<div class="modal fade" id="reviewViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Review Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row g-4">
          <!-- Left Column: Customer & Product Info -->
          <div class="col-lg-5">
            <div class="p-3 border rounded  mb-3">
              <h5 class="mb-3">Customer & Product Information</h5>
              <p><strong>Name:</strong> <span id="viewCustomerName"></span></p>
              <p><strong>Email:</strong> <span id="viewCustomerEmail"></span></p>

              <p class="mt-3"><strong>Product Name:</strong> <span id="viewProductName"></span></p>
              <p><strong>Category:</strong> <span id="viewProductCategory"></span></p>
              <p><strong>Rating:</strong> <span id="viewProductRating"></span></p>
              <p><strong>Date:</strong> <span id="viewReviewDate"></span></p>
            </div>
          </div>

          <!-- Right Column: Comment & Images -->
          <div class="col-lg-7">
            <div class="p-3 border rounded mb-3">
              <h5 class="mb-2">Comment</h5>
              <p id="viewProductComment" class="p-2 bg-light rounded"></p>
            </div>

            <div id="imagesContainerWrapper" class="p-3 border rounded d-none">
              <h5 class="mb-2">Images</h5>
              <div id="viewProductImages" class="d-flex gap-2 flex-wrap">
                <!-- Images will go here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer removed as per request -->
    </div>
  </div>
</div>



    </section>

    <!-- ========================= CONTACT US PAGE ======================= -->
    <!-- Contact Us Management -->
    <section id="contact-us-management" class="content-section">
      <h2>Contact Us Management</h2>
      <div class="card mb-4">
        <div class="card-header">Store Contact Information</div>
        <div class="card-body">
          <!-- Table -->
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Type</th>
                <th>Detail</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contactTableBody"></tbody>
          </table>

          <!-- ✅ Edit Modal -->
          <div class="modal fade" id="editContactModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header btn btn-info">
                  <h5 class="modal-title">Edit Contact Info</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <form id="editForm">
                    <input type="hidden" id="fieldType">
                    <div class="mb-3">
                      <label class="form-label" id="fieldLabel"></label>
                      <input type="text" id="fieldValue" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-info">Save</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Messages -->
      <div class="card">
        <div class="card-header">Contact Form Messages</div>
        <div class="card-body">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Message</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="contactsTableBody">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="contactDeleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this message?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" id="confirmContactDeleteBtn" class="btn btn-danger">Delete</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========================= SITE SETTING PAGE ======================= -->
    <!-- Site Setting -->
    <section id="site-settings" class="content-section" style="display: none;">
      <h2 class="mb-4">Site Settings</h2>
      <form id="siteSettingsForm" class="space-y-3" autocomplete="off">
        <div class="mb-3">
          <label class="form-label">Estimated Delivery</label>
          <input type="text" id="estimatedDelivery" class="form-control" placeholder="e.g., 3-5 business days" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label class="form-label">Special Offer Text</label>
          <input type="text" id="specialOfferText" class="form-control" placeholder="e.g., Free delivery above Rs. 2000" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label class="form-label">Free Delivery Above (Rs.)</label>
          <input type="number" id="freeDeliveryAbove" class="form-control" placeholder="e.g., 2000" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label class="form-label">Delivery Charges (Rs.)</label>
          <input type="number" id="deliveryCharges" class="form-control" placeholder="e.g., 200" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label class="form-label">Tax (%)</label>
          <input type="number" id="tax" class="form-control" placeholder="e.g., 13" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label class="form-label">Return Policy</label>
          <textarea id="returnPolicy" class="form-control" rows="2" placeholder="e.g., 30-day easy returns" autocomplete="off"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Business Hours</label>
          <input type="text" id="businessHours" class="form-control" placeholder="e.g., Mon–Sat: 10:00 AM – 8:00 PM" autocomplete="off" />
        </div>
        <button type="submit" class="btn btn-primary">Save Settings</button>
        <p id="settingsMessage" class="mt-2 fw-semibold"></p>
      </form>
    </section>
    <!-- Site Setting JS -->
    <script>
      const links = document.querySelectorAll('.nav-link[data-section]');
      const sections = document.querySelectorAll('.content-section');

      links.forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const sectionId = link.getAttribute('data-section');
          sections.forEach(sec => sec.style.display = 'none');
          document.getElementById(sectionId).style.display = 'block';
    
          // Call specific load function if available
          if (sectionId === 'site-settings') {
            loadSiteSettings();
          }
        });
      });

      async function loadSiteSettings() {
        const msg = document.getElementById("settingsMessage");
        msg.textContent = "";

        try {
          const res = await fetch("/api/site-settings");
          const data = await res.json();
          if (data.success && data.settings) {
            const s = data.settings;
            document.getElementById("estimatedDelivery").value = s.estimatedDelivery || "";
            document.getElementById("specialOfferText").value = s.specialOfferText || "";
            document.getElementById("freeDeliveryAbove").value = s.freeDeliveryAbove || "";
            document.getElementById("deliveryCharges").value = s.deliveryCharges || "";
            document.getElementById("tax").value = s.tax || "";
            document.getElementById("returnPolicy").value = s.returnPolicy || "";
            document.getElementById("businessHours").value = s.businessHours || "";
          }
        } catch (err) {
          console.error("Error loading site settings:", err);
        }
      }

      document.getElementById("siteSettingsForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = document.getElementById("settingsMessage");
        msg.textContent = "";

        const fields = [
          "estimatedDelivery",
          "specialOfferText",
          "freeDeliveryAbove",
          "deliveryCharges",
          "tax",
          "returnPolicy",
          "businessHours"
        ];

        // Check if any field is empty
        const empty = fields.some(id => !document.getElementById(id).value.trim());
        if (empty) {
          msg.textContent = "Please fill out all fields before saving.";
          msg.className = "mt-2 text-danger fw-semibold";
          setTimeout(() => (msg.textContent = ""), 3000);
          return;
        }

        // Prepare updated data
        const updated = {
          estimatedDelivery: document.getElementById("estimatedDelivery").value.trim(),
          specialOfferText: document.getElementById("specialOfferText").value.trim(),
          freeDeliveryAbove: Number(document.getElementById("freeDeliveryAbove").value),
          deliveryCharges: Number(document.getElementById("deliveryCharges").value),
          tax: Number(document.getElementById("tax").value),
          returnPolicy: document.getElementById("returnPolicy").value.trim(),
          businessHours: document.getElementById("businessHours").value.trim()
        };

        try {
          const res = await fetch("/api/site-settings", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated)
          });

          const data = await res.json();

          if (data.success) {
            msg.textContent = "Settings updated successfully!";
            msg.className = "mt-2 text-primary fw-semibold"; // Blue success message
          } else {
            msg.textContent = "Failed to update settings.";
            msg.className = "mt-2 text-danger fw-semibold";
          }
        } catch (err) {
          msg.textContent = "Error saving settings.";
          msg.className = "mt-2 text-danger fw-semibold";
          console.error(err);
        }

        setTimeout(() => (msg.textContent = ""), 3000);
      });
    </script>

  </main>

  <footer class="footer">&copy; 2025 Khalid Optics & Watches</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Dashboard Overview JS -->
<!-- <script>
document.addEventListener('DOMContentLoaded', function () {
  const sidebarLinks = document.querySelectorAll('#sidebar .nav-link');
  const sections = document.querySelectorAll('.content-section');

  function showSection(id) {
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === 'dashboard-overview') {
      loadDashboardData();
    }
  }

  sidebarLinks.forEach(link => {
    link.addEventListener('click', e => {
      if (!link.dataset.bsToggle) {
        e.preventDefault();
        sidebarLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        showSection(link.dataset.section);
      }
    });
  });

  showSection('dashboard-overview');

  async function loadDashboardData() {
    try {
      const ordersRes = await fetch("/api/orders");
      const orders = await ordersRes.json();

      const reviewsRes = await fetch("/api/reviews");
      const reviews = await reviewsRes.json();

      document.getElementById("totalOrders").textContent = orders.length;
      document.getElementById("pendingOrdersCount").textContent = orders.filter(o => o.orderStatus === "pending").length;
      document.getElementById("customerReviewsCount").textContent = reviews.length;

      renderMonthlyOrdersChart(orders);
      renderSalesByCategoryChart(orders);
    } catch (err) {
      console.error("Error loading dashboard data:", err);
    }
  }

  function renderMonthlyOrdersChart(orders) {
    const ctx = document.getElementById("monthlyOrdersChart").getContext("2d");
    const monthlyCounts = Array(12).fill(0);

    orders
      .filter(o => o.orderStatus === "accepted") // Only accepted orders
      .forEach(o => {
        const month = new Date(o.orderDate).getMonth();
        monthlyCounts[month]++;
      });

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
        datasets: [{
          label: "Orders",
          data: monthlyCounts,
          backgroundColor: "rgba(0, 123, 255, 0.5)",
          borderColor: "rgba(0, 123, 255, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 10 }
          }
        }
      }
    });
  }

  function renderSalesByCategoryChart(orders) {
    const ctx = document.getElementById("salesByCategoryChart").getContext("2d");
    const categoryTotals = { Eyeglasses: 0, Sunglasses: 0, Watches: 0, Lenses: 0 };

    orders
      .filter(order => order.orderStatus === "accepted") // Only accepted orders
      .forEach(order => {
        order.items.forEach(item => {
          if (["metalFrames", "regularGlasses", "brandedFrames", "kidsEyeglasses"].includes(item.category)) {
            categoryTotals.Eyeglasses += item.subtotal;
          } else if (["metalSunglasses", "regularSunglasses", "brandedSunglasses", "kidsSunglasses"].includes(item.category)) {
            categoryTotals.Sunglasses += item.subtotal;
          } else if (["gentsWatches", "ladiesWatches", "premiumWatches", "kidsWatches"].includes(item.category)) {
            categoryTotals.Watches += item.subtotal;
          } else if (["PowerLenses", "ColoredLenses"].includes(item.category)) {
            categoryTotals.Lenses += item.subtotal;
          }
        });
      });

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ["Eyeglasses", "Sunglasses", "Watches", "Lenses"], // Order as requested
        datasets: [{
          data: [
            categoryTotals.Eyeglasses,
            categoryTotals.Sunglasses,
            categoryTotals.Watches,
            categoryTotals.Lenses
          ],
          backgroundColor: [
            'rgba(0, 123, 255, 0.7)',    // Eyeglasses
            'rgba(255, 193, 7, 0.7)',    // Sunglasses
            'rgba(220, 53, 69, 0.7)',    // Watches
            'rgba(40, 167, 69, 0.7)'     // Lenses
          ]
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
});
</script> -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const sidebarLinks = document.querySelectorAll('#sidebar .nav-link');
  const sections = document.querySelectorAll('.content-section');

  function showSection(id) {
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === 'dashboard-overview') {
      loadDashboardData();
    }
  }

  sidebarLinks.forEach(link => {
    link.addEventListener('click', e => {
      if (!link.dataset.bsToggle) {
        e.preventDefault();
        sidebarLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        showSection(link.dataset.section);
      }
    });
  });

  showSection('dashboard-overview');

  async function loadDashboardData() {
    try {
      const ordersRes = await fetch("/api/orders");
      const orders = await ordersRes.json();

      const reviewsRes = await fetch("/api/reviews");
      const reviews = await reviewsRes.json();

      document.getElementById("totalOrders").textContent = orders.length;
      document.getElementById("pendingOrdersCount").textContent = orders.filter(o => o.orderStatus === "pending").length;
      document.getElementById("customerReviewsCount").textContent = reviews.length;

      window.ordersData = orders; // store globally

      populateYearSelector(orders); // populate year dropdown
      populateMonthSelector();      // populate month dropdown for pie chart

      renderMonthlyOrdersChart(orders); // initial chart
      renderSalesByCategoryChart(orders, new Date().getMonth()); // initial pie chart
    } catch (err) {
      console.error("Error loading dashboard data:", err);
    }
  }

  // Year dropdown functionality
  function populateYearSelector(orders) {
    const yearSelect = document.getElementById("yearSelect");
    if (!yearSelect) return;

    const currentYear = new Date().getFullYear();
    const yearsFromOrders = [...new Set(orders.map(o => new Date(o.orderDate).getFullYear()))];
    const years = Array.from(new Set([...yearsFromOrders, currentYear])).sort((a, b) => b - a);

    yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
    yearSelect.value = currentYear;

    // On year change, update charts
    yearSelect.addEventListener("change", () => {
      renderMonthlyOrdersChart(window.ordersData);
      renderSalesByCategoryChart(window.ordersData, document.getElementById("monthSelect").value);
    });
  }

  // Month dropdown functionality for Sales by Category chart
  function populateMonthSelector() {
    const monthSelect = document.getElementById("monthSelect");
    if (!monthSelect) return;

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    monthSelect.innerHTML = monthNames.map((name, index) => `<option value="${index}">${name}</option>`).join("");

    // Default to current month
    monthSelect.value = new Date().getMonth();

    monthSelect.addEventListener("change", () => {
      renderSalesByCategoryChart(window.ordersData, monthSelect.value);
    });
  }

  function renderMonthlyOrdersChart(orders) {
    const yearSelect = document.getElementById("yearSelect");
    const selectedYear = yearSelect ? Number(yearSelect.value) : new Date().getFullYear();
    const ctx = document.getElementById("monthlyOrdersChart").getContext("2d");
    const monthlyCounts = Array(12).fill(0);

    orders
      .filter(o => o.orderStatus === "accepted" && new Date(o.orderDate).getFullYear() === selectedYear)
      .forEach(o => {
        const month = new Date(o.orderDate).getMonth();
        monthlyCounts[month]++;
      });

    if (window.monthlyChart) {
      window.monthlyChart.data.datasets[0].data = monthlyCounts;
      window.monthlyChart.update();
    } else {
      window.monthlyChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
          datasets: [{
            label: "Orders",
            data: monthlyCounts,
            backgroundColor: "rgba(0, 123, 255, 0.5)",
            borderColor: "rgba(0, 123, 255, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } }
        }
      });
    }
  }

  function renderSalesByCategoryChart(orders, month) {
    const ctx = document.getElementById("salesByCategoryChart").getContext("2d");
    const categoryTotals = { Eyeglasses: 0, Sunglasses: 0, Watches: 0, Lenses: 0 };

    const yearSelect = document.getElementById("yearSelect");
    const selectedYear = yearSelect ? Number(yearSelect.value) : new Date().getFullYear();

    orders
      .filter(order => order.orderStatus === "accepted")
      .filter(order => new Date(order.orderDate).getFullYear() === selectedYear)
      .filter(order => new Date(order.orderDate).getMonth() == month)
      .forEach(order => {
        order.items.forEach(item => {
          if (["metalFrames", "regularGlasses", "brandedFrames", "kidsEyeglasses"].includes(item.category)) {
            categoryTotals.Eyeglasses += item.subtotal;
          } else if (["metalSunglasses", "regularSunglasses", "brandedSunglasses", "kidsSunglasses"].includes(item.category)) {
            categoryTotals.Sunglasses += item.subtotal;
          } else if (["gentsWatches", "ladiesWatches", "premiumWatches", "kidsWatches"].includes(item.category)) {
            categoryTotals.Watches += item.subtotal;
          } else if (["PowerLenses", "ColoredLenses"].includes(item.category)) {
            categoryTotals.Lenses += item.subtotal;
          }
        });
      });

    // Destroy old chart if exists
    if (window.salesChart) window.salesChart.destroy();

    window.salesChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ["Eyeglasses", "Sunglasses", "Watches", "Lenses"],
        datasets: [{
          data: [
            categoryTotals.Eyeglasses,
            categoryTotals.Sunglasses,
            categoryTotals.Watches,
            categoryTotals.Lenses
          ],
          backgroundColor: [
            'rgba(0, 123, 255, 0.7)',    
            'rgba(255, 193, 7, 0.7)',    
            'rgba(220, 53, 69, 0.7)',    
            'rgba(40, 167, 69, 0.7)'     
          ]
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
});
</script>




<!-- Review Managements JS-->
<!-- <script>
const reviewsTableBody = document.getElementById("reviewsTableBody");
const deleteModal = new bootstrap.Modal(document.getElementById('reviewDeleteModal'));
let reviewIdToDelete = null;

function renderStars(rating) {
  return "★".repeat(rating) + "☆".repeat(5 - rating);
}

async function loadReviews() {
  try {
    const response = await fetch("/api/reviews"); 
    const reviews = await response.json();

    reviewsTableBody.innerHTML = "";

    reviews.forEach((review, index) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${reviews.length - index}</td>
        <td>${review.name}</td>
        <td>${review.productName || "-"}</td>
        <td><span class="text-warning">${renderStars(review.rating)}</span></td>
        <td class="comment-cell">${review.feedback}</td>
        <td>${new Date(review.createdAt).toISOString().split("T")[0]}</td>
        <td class="text-center">
          <button class="btn btn-warning btn-sm view-btn" data-id="${review._id}">
            <i class="fas fa-eye"></i> View
          </button>
          <button class="btn btn-danger btn-sm delete-btn" data-id="${review._id}">
            <i class="fas fa-trash"></i> Delete
          </button>
        </td>
      `;

      // handle long review toggle
      const commentCell = tr.querySelector(".comment-cell");
      commentCell.addEventListener("click", () => {
        commentCell.classList.toggle("expanded");
      });

      reviewsTableBody.prepend(tr);
    });

    // attach delete event using modal
    document.querySelectorAll(".delete-btn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        reviewIdToDelete = e.currentTarget.dataset.id;
        deleteModal.show();
      });
    });

  } catch (error) {
    console.error("Error loading reviews:", error);
  }
}

// Confirm delete inside modal
document.getElementById("confirmReviewDeleteBtn").addEventListener("click", async () => {
  if (reviewIdToDelete) {
    await fetch(`/api/reviews/${reviewIdToDelete}`, { method: "DELETE" });
    reviewIdToDelete = null;
    deleteModal.hide();
    loadReviews(); // refresh table
  }
});

// Call on page load
loadReviews();
</script> -->
<script>
const reviewsTableBody = document.getElementById("reviewsTableBody");
const deleteModal = new bootstrap.Modal(document.getElementById('reviewDeleteModal'));
const viewModal = new bootstrap.Modal(document.getElementById('reviewViewModal'));
let reviewIdToDelete = null;

function renderStars(rating) {
  return "★".repeat(rating) + "☆".repeat(5 - rating);
}

async function loadReviews() {
  try {
    const response = await fetch("/api/reviews"); 
    const reviews = await response.json();

    reviewsTableBody.innerHTML = "";

    reviews.forEach((review, index) => {
      const tr = document.createElement("tr");

      // Unique IDs for each row's view button
      const viewBtnId = `viewBtn-${review._id}`;
      const deleteBtnId = `deleteBtn-${review._id}`;
      const publishBtnId = `publishBtn-${review._id}`;
const isPublished = review.published;

      tr.innerHTML = `
        <td>${reviews.length - index}</td>
        <td>${review.name}</td>
        <td>${review.productName || "-"}</td>
        <td><span class="text-warning">${renderStars(review.rating)}</span></td>
        <td class="comment-cell">${review.feedback}</td>
        <td>${new Date(review.createdAt).toLocaleDateString()}</td>
        <td class="text-center">
          <div class="btn-group me-2" role="group">
          <button id="${viewBtnId}" class="btn btn-warning btn-sm me-1">
            <i class="fas fa-eye"></i> View
          </button>
          <button id="${deleteBtnId}" class="btn btn-danger btn-sm">
            <i class="fas fa-trash"></i> Delete
          </button>
          </div>
          <div class="btn-group">
          <button id="${publishBtnId}" class="btn btn-sm ${isPublished ? 'btn-success' : 'btn-info'}"  style="width: 100px;">
            <i class="fas ${isPublished ? 'fa-check' : 'fa-upload'}"></i>
            ${isPublished ? 'Published' : 'Publish'}
          </button>
          </div>
        </td>
      `;

      // Handle long review toggle
      const commentCell = tr.querySelector(".comment-cell");
      commentCell.addEventListener("click", () => {
        commentCell.classList.toggle("expanded");
      });

      reviewsTableBody.prepend(tr);

      // Attach View button listener
      document.getElementById(viewBtnId).addEventListener("click", async () => {
        try {
          const res = await fetch(`/api/reviews/${review._id}`);
          const data = await res.json();

          // Fill modal fields
          document.getElementById("viewCustomerName").innerText = data.name;
          document.getElementById("viewCustomerEmail").innerText = data.email;
          document.getElementById("viewProductName").innerText = data.productName || "-";
          document.getElementById("viewProductCategory").innerText = data.productCategory || "-";
          document.getElementById("viewProductRating").innerHTML = renderStars(data.rating);
          document.getElementById("viewProductComment").innerText = data.feedback;
          document.getElementById("viewReviewDate").innerText = new Date(data.createdAt).toLocaleString();

          // Images section handling
          const imagesWrapper = document.getElementById("imagesContainerWrapper");
          const imagesContainer = document.getElementById("viewProductImages");
          imagesContainer.innerHTML = "";

          if (data.images && data.images.length > 0) {
            imagesWrapper.classList.remove("d-none");
            data.images.forEach(url => {
              const img = document.createElement("img");
              img.src = url;
              img.style.width = "120px";
              img.style.height = "120px";
              img.style.objectFit = "cover";
              img.classList.add("rounded", "border");
              imagesContainer.appendChild(img);
            });
          } else {
            imagesWrapper.classList.add("d-none"); // hide section if no images
          }

          viewModal.show();
        } catch (err) {
          console.error("Error fetching review:", err);
        }
      });

      // Attach Delete button listener
      document.getElementById(deleteBtnId).addEventListener("click", () => {
        reviewIdToDelete = review._id;
        deleteModal.show();
      });

      const publishBtn = document.getElementById(`publishBtn-${review._id}`);
publishBtn.addEventListener("click", async () => {
  try {
    const res = await fetch(`/api/reviews/publish/${review._id}`, { method: "PUT" });
    if (!res.ok) throw new Error("Failed to publish review");

    // Change button to green and update text/icon
    publishBtn.classList.remove("btn-info");
    publishBtn.classList.add("btn-success");
    publishBtn.innerHTML = '<i class="fas fa-check"></i> Published';
  } catch (err) {
    console.error("Error publishing review:", err);
    alert("Could not publish review. Try again.");
  }
});
    });

  } catch (error) {
    console.error("Error loading reviews:", error);
  }
}

// Confirm delete inside modal
document.getElementById("confirmReviewDeleteBtn").addEventListener("click", async () => {
  if (reviewIdToDelete) {
    await fetch(`/api/reviews/${reviewIdToDelete}`, { method: "DELETE" });
    reviewIdToDelete = null;
    deleteModal.hide();
    loadReviews(); // refresh table
  }
});

// Load reviews on page load
loadReviews();
</script>


<!-- JS for Contact Info-->
<script>
  async function loadContactInfo() {
    const response = await fetch("http://localhost:3000/api/contact-info");
    const data = await response.json();

    const tbody = document.getElementById("contactTableBody");
    tbody.innerHTML = `
      <tr>
        <td>Address</td>
        <td>${data.address}</td>
        <td>
          <button class="btn btn-info btn-sm" onclick="openEdit('address', '${data.address}')">
            <i class="fas fa-edit"></i> Edit
          </button>
        </td>
      </tr>
      <tr>
        <td>Phone</td>
        <td>${data.phone}</td>
        <td>
          <button class="btn btn-info btn-sm" onclick="openEdit('phone', '${data.phone}')">
            <i class="fas fa-edit"></i> Edit
          </button>
        </td>
      </tr>
      <tr>
        <td>Email</td>
        <td>${data.email}</td>
        <td>
          <button class="btn btn-info btn-sm" onclick="openEdit('email', '${data.email}')">
            <i class="fas fa-edit"></i> Edit
          </button>
        </td>
      </tr>
    `;
  }

  function openEdit(type, value) {
    document.getElementById("fieldType").value = type;
    document.getElementById("fieldLabel").textContent = `Edit ${type}`;
    document.getElementById("fieldValue").value = value;

    const modal = new bootstrap.Modal(document.getElementById("editContactModal"));
    modal.show();
  }

  document.getElementById("editForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const type = document.getElementById("fieldType").value;
    const value = document.getElementById("fieldValue").value;

    await fetch("http://localhost:3000/api/contact-info", {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ [type]: value })
    });

    bootstrap.Modal.getInstance(document.getElementById("editContactModal")).hide();
    loadContactInfo();
  });

  loadContactInfo();
</script>

<!--contact messages JS-->
<script>
  async function loadContacts() {
    try {
      const res = await fetch("/api/contact");
      const data = await res.json();

      const tableBody = document.getElementById("contactsTableBody");
      tableBody.innerHTML = "";

      if (data.success && data.data.length > 0) {
        data.data.forEach((c, i) => {
          const preview =
            c.message.length > 30 ? c.message.substring(0, 30) + "..." : c.message;

          tableBody.innerHTML += `
            <tr>
              <td>${i + 1}</td>
              <td>${c.name}</td>
              <td>${c.email}</td>
              <td class="message-cell">${c.message}</td>
              <td>${new Date(c.createdAt).toLocaleString()}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="openDeleteModal('${c._id}')">
                   <i class="fas fa-trash"></i> Delete
                </button>

              </td>
            </tr>
          `;
        });

        // ✅ attach toggle after rendering
        document.querySelectorAll(".message-cell").forEach(cell => {
          cell.addEventListener("click", () => {
            cell.classList.toggle("expanded");
          });
        });
      } else {
        tableBody.innerHTML = "<tr><td colspan='6'>No messages yet</td></tr>";
      }
    } catch (err) {
      console.error("Error loading contacts:", err);
    }
  }

  window.addEventListener("DOMContentLoaded", loadContacts);


  //delete record
  let contactToDelete = null; // store which record should be deleted

  // Open modal when delete button clicked
  function openDeleteModal(id) {
    contactToDelete = id;
    const modal = new bootstrap.Modal(document.getElementById("contactDeleteModal"));
    modal.show();
  }

  // Confirm delete
  document.getElementById("confirmContactDeleteBtn").addEventListener("click", async () => {
    if (!contactToDelete) return;

    try {
      const res = await fetch(`/api/contact/${contactToDelete}`, { method: "DELETE" });
      const data = await res.json();

      if (data.success) {
        // Refresh table
        loadContacts();
      }
    } catch (err) {
      console.error("Error deleting:", err);
    }

    // Close modal
    const modalEl = document.getElementById("contactDeleteModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  });
</script>


</body>
</html>
